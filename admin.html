<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin - Rija Cars</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Styles spécifiques Admin pour ne pas surcharger style.css */
        .admin-body { background: #f0f2f5; color: #333; padding: 20px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        .car-admin-item { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; padding: 10px 0; }
        .car-admin-item img { width: 80px; height: 50px; object-fit: cover; border-radius: 6px; }
        .toggle-label { font-size: 0.85rem; color: #666; margin-left: 10px; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9rem; }
        th { background: #f8f9fa; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-attente { background: #fff3cd; color: #856404; }
        .badge-valide { background: #d4edda; color: #155724; }
    </style>
</head>
<body class="admin-body">

<div class="admin-header">
    <h1><i class="fas fa-cogs"></i> Administration</h1>
    <a href="index.html" class="btn-primary-large" style="width:auto; padding: 10px 20px; margin:0;">Retour Site</a>
</div>

<section class="admin-card">
    <h2><i class="fas fa-car"></i> Gestion Affichage Calendrier</h2>
    <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">Activez ou désactivez l'affichage du calendrier public pour chaque voiture.</p>
    <div id="liste-voitures-admin">
        Chargement...
    </div>
</section>

<section class="admin-card">
    <h2><i class="fas fa-list-alt"></i> Demandes de Réservation</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Client</th>
                    <th>Véhicule</th>
                    <th>Dates</th>
                    <th>Logistique (Livr/Récup)</th>
                    <th>Trajet Prévu</th>
                    <th>Prix Total</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="table-reservations">
                </tbody>
        </table>
    </div>
</section>

<script>
    // --- SUPABASE ADMIN ---
    const sb = supabase.createClient(
        'https://ctijwjcjmbfmfhzwbguk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk'
    );

    async function initAdmin() {
        chargerVoituresAdmin();
        chargerReservations();
    }

    // 1. VOITURES & TOGGLE
    async function chargerVoituresAdmin() {
        const { data: voitures } = await sb.from('voitures').select('*').order('id');
        const container = document.getElementById('liste-voitures-admin');
        container.innerHTML = '';

        voitures.forEach(v => {
            container.innerHTML += `
                <div class="car-admin-item">
                    <img src="${v.image_url}" alt="car">
                    <div style="flex:1;">
                        <strong>${v.nom}</strong>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <label class="switch">
                            <input type="checkbox" ${v.calendrier_public ? 'checked' : ''} onchange="updateCal(${v.id}, this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">${v.calendrier_public ? 'Calendrier Visible' : 'Calendrier Caché'}</span>
                    </div>
                </div>
            `;
        });
    }

    async function updateCal(id, etat) {
        await sb.from('voitures').update({ calendrier_public: etat }).eq('id', id);
        // Feedback visuel optionnel
    }

    // 2. RESERVATIONS
    async function chargerReservations() {
        const { data: resas } = await sb.from('reservations')
            .select('*, voitures(nom)')
            .order('created_at', { ascending: false });
            
        const tbody = document.getElementById('table-reservations');
        tbody.innerHTML = '';

        resas.forEach(r => {
            tbody.innerHTML += `
                <tr>
                    <td>
                        <strong>${r.nom}</strong><br>
                        <i class="fas fa-phone"></i> ${r.tel}
                    </td>
                    <td>${r.voitures ? r.voitures.nom : '<i>Supprimé</i>'}</td>
                    <td>
                        Du ${new Date(r.date_debut).toLocaleDateString()}<br>
                        Au ${new Date(r.date_fin).toLocaleDateString()}
                    </td>
                    <td>
                        <small>
                            <b>Livr:</b> ${r.lieu_livraison || '-'} (${r.heure_livraison || '-'})<br>
                            <b>Recup:</b> ${r.lieu_recup || '-'} (${r.heure_recup || '-'})
                        </small>
                    </td>
                    <td>
                        <small>
                            1. ${r.trajet_1 || '-'}<br>
                            2. ${r.trajet_2 || '-'}
                        </small>
                    </td>
                    <td>${r.montant_total ? r.montant_total.toLocaleString() : 0} Ar</td>
                    <td><span class="badge badge-${r.statut}">${r.statut}</span></td>
                </tr>
            `;
        });
    }

    window.onload = initAdmin;
</script>

</body>
</html>