<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rija Niaina Car Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Styles spÃ©cifiques Admin */
        body { background-color: #f4f6f9; }
        .admin-layout { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header-bar {
            background: white; padding: 15px 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        
        .role-badge {
            padding: 5px 10px; border-radius: 15px; color: white; 
            font-size: 0.8rem; font-weight: bold; text-transform: uppercase;
        }
        .badge-admin { background-color: #e74c3c; }
        .badge-partner { background-color: #3498db; }

        /* Onglets */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 20px; border: none; background: white; 
            cursor: pointer; border-radius: 5px; font-weight: 600; color: #555;
            transition: 0.3s;
        }
        .tab-btn:hover { background: #eee; }
        .tab-btn.active { background: #2c3e50; color: white; }
        
        /* Masquer pour partenaire */
        .super-admin-only { display: none !important; }
        body.is-super-admin .super-admin-only { display: inline-block !important; }
        body.is-super-admin .row-super-admin { display: table-row !important; }

        /* Grille Voitures */
        .grid-cars { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }

        /* Tableaux */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #2c3e50; color: white; }

        /* Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 30px; border-radius: 8px; width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: #3498db; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Espace Pro</h2>
            <p>Rija Niaina Car Services</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="handleLogin()">Se connecter</button>
            <p id="error-msg" style="color:red; display:none; margin-top:10px;"></p>
        </div>
    </div>

    <div id="admin-interface" class="admin-layout" style="display:none;">
        <div class="header-bar">
            <div>
                <h2 style="margin:0;">Tableau de Bord</h2>
                <small id="user-email-display">...</small>
            </div>
            <div>
                <span id="role-display" class="role-badge badge-partner">Chargement...</span>
                <button onclick="handleLogout()" style="margin-left:15px; padding:5px 10px; background:#c0392b; color:white; border:none; border-radius:4px; cursor:pointer;">DÃ©connexion</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('voitures')">ðŸš— Mes Voitures</button>
            <button class="tab-btn" onclick="showTab('reservations')">ðŸ“… RÃ©servations</button>
            <button class="tab-btn super-admin-only" onclick="showTab('utilisateurs')">ðŸ‘¥ Utilisateurs (Admin)</button>
        </div>

        <div id="tab-voitures">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>Gestion Flotte</h3>
                <button onclick="openModalCar()" style="background:#27ae60; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">+ Nouvelle Voiture</button>
            </div>
            <div id="cars-grid" class="grid-cars">
                <p>Chargement...</p>
            </div>
        </div>

        <div id="tab-reservations" style="display:none;">
            <h3>Suivi RÃ©servations</h3>
            <table>
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Client</th>
                        <th>Voiture</th>
                        <th>Dates</th>
                        <th>Total</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody id="resas-tbody"></tbody>
            </table>
        </div>

        <div id="tab-utilisateurs" style="display:none;">
            <h3>Gestion des RÃ´les</h3>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>RÃ´le Actuel</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-car" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:400px; position:relative;">
            <span onclick="document.getElementById('modal-car').style.display='none'" style="position:absolute; right:15px; top:10px; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h3>Ajouter Voiture</h3>
            <input type="text" id="car-nom" placeholder="Nom (ex: Toyota V8)" style="width:100%; margin-bottom:10px; padding:8px;">
            <input type="text" id="car-ref" placeholder="Immatriculation / Ref" style="width:100%; margin-bottom:10px; padding:8px;">
            <input type="number" id="car-prix" placeholder="Prix par jour (Ar)" style="width:100%; margin-bottom:10px; padding:8px;">
            <input type="text" id="car-img" placeholder="URL Image" style="width:100%; margin-bottom:10px; padding:8px;">
            <textarea id="car-desc" placeholder="Description" style="width:100%; margin-bottom:10px; padding:8px;"></textarea>
            <label><input type="checkbox" id="car-reservable" checked> RÃ©servable en ligne</label>
            <br><br>
            <button onclick="saveCar()" style="width:100%; background:#27ae60; color:white; border:none; padding:10px; cursor:pointer;">Enregistrer</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG SUPABASE ---
        const SUPABASE_URL = 'https://ctijwjcjmbfmfhzwbguk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentRole = 'partenaire';

        // --- 2. AUTHENTIFICATION ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if(error) {
                document.getElementById('error-msg').innerText = error.message;
                document.getElementById('error-msg').style.display = 'block';
            } else {
                window.location.reload();
            }
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // --- 3. INITIALISATION ---
        async function initAdmin() {
            const { data: { session } } = await sb.auth.getSession();
            
            if(!session) {
                document.getElementById('login-screen').style.display = 'flex';
                return;
            }

            currentUser = session.user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-interface').style.display = 'block';
            document.getElementById('user-email-display').innerText = currentUser.email;

            // RÃ©cupÃ©ration ou crÃ©ation du profil partenaire
            let { data: partner } = await sb.from('partenaires').select('*').eq('user_id', currentUser.id).single();
            
            if(!partner) {
                // CrÃ©ation auto si n'existe pas
                const { data: newP } = await sb.from('partenaires').insert([{
                    user_id: currentUser.id,
                    email: currentUser.email,
                    role: 'partenaire'
                }]).select().single();
                partner = newP;
            }

            // Gestion RÃ´les
            currentRole = partner ? partner.role : 'partenaire';
            
            const roleBadge = document.getElementById('role-display');
            roleBadge.innerText = currentRole === 'super_admin' ? 'SUPER ADMIN' : 'PARTENAIRE';
            roleBadge.className = `role-badge ${currentRole === 'super_admin' ? 'badge-admin' : 'badge-partner'}`;

            if(currentRole === 'super_admin') {
                document.body.classList.add('is-super-admin');
                loadAllUsers(); // Seulement si admin
            }

            // Chargement donnÃ©es
            loadCars();
            loadReservations();
        }

        // --- 4. GESTION VOITURES ---
        async function loadCars() {
            const container = document.getElementById('cars-grid');
            container.innerHTML = 'Chargement...';

            // GrÃ¢ce au RLS : Admin reÃ§oit tout, Partenaire reÃ§oit que les siennes
            const { data: cars } = await sb.from('voitures').select('*').order('created_at', {ascending:false});
            
            container.innerHTML = '';
            if(cars && cars.length > 0) {
                cars.forEach(c => {
                    container.innerHTML += `
                    <div class="card">
                        <img src="${c.image_url || 'https://via.placeholder.com/300'}" alt="${c.nom}">
                        <h4>${c.nom}</h4>
                        <p>${c.prix_base} Ar/jour</p>
                        <small style="color:gray">${c.reservable ? 'âœ… RÃ©servable' : 'ðŸ“ž Contact'}</small>
                        <div style="margin-top:10px;">
                             <button onclick="deleteCar('${c.id}')" style="background:#e74c3c; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">Supprimer</button>
                        </div>
                    </div>`;
                });
            } else {
                container.innerHTML = '<p>Aucune voiture trouvÃ©e.</p>';
            }
        }

        async function saveCar() {
            const nom = document.getElementById('car-nom').value;
            const prix = document.getElementById('car-prix').value;
            const ref = document.getElementById('car-ref').value;
            const img = document.getElementById('car-img').value;
            const desc = document.getElementById('car-desc').value;
            const reservable = document.getElementById('car-reservable').checked;

            if(!nom || !prix) return alert('Champs requis !');

            const { error } = await sb.from('voitures').insert([{
                nom, 
                ref_id: ref,
                prix_base: parseInt(prix),
                image_url: img,
                description: desc,
                reservable: reservable,
                proprietaire_id: currentUser.id // Lien crucial
            }]);

            if(error) alert('Erreur: ' + error.message);
            else {
                document.getElementById('modal-car').style.display = 'none';
                loadCars();
            }
        }

        async function deleteCar(id) {
            if(!confirm('Supprimer cette voiture ?')) return;
            const { error } = await sb.from('voitures').delete().eq('id', id);
            if(error) alert('Erreur: ' + error.message);
            else loadCars();
        }

        // --- 5. GESTION RESERVATIONS ---
        async function loadReservations() {
            const tbody = document.getElementById('resas-tbody');
            const { data: resas } = await sb.from('reservations').select('*, voitures(nom)').order('created_at', {ascending:false});
            
            tbody.innerHTML = '';
            if(resas) {
                resas.forEach(r => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.nom}<br><small>${r.tel}</small></td>
                        <td>${r.voitures ? r.voitures.nom : 'Sup.'}</td>
                        <td>${r.date_debut} / ${r.date_fin}</td>
                        <td>${r.montant_total} Ar</td>
                        <td>${r.statut}</td>
                    </tr>`;
                });
            }
        }

        // --- 6. GESTION UTILISATEURS (ADMIN ONLY) ---
        async function loadAllUsers() {
            const tbody = document.getElementById('users-tbody');
            const { data: users, error } = await sb.from('partenaires').select('*');
            
            if(error) return; // Normal si pas admin
            
            tbody.innerHTML = '';
            users.forEach(u => {
                const isMe = u.user_id === currentUser.id;
                let btn = '';
                
                if(!isMe) {
                    if(u.role === 'partenaire') {
                        btn = `<button onclick="setRole('${u.user_id}', 'super_admin')" style="background:#27ae60; color:white; border:none; cursor:pointer;">Promouvoir Admin</button>`;
                    } else {
                        btn = `<button onclick="setRole('${u.user_id}', 'partenaire')" style="background:#e67e22; color:white; border:none; cursor:pointer;">RÃ©trograder</button>`;
                    }
                } else {
                    btn = '<small>(Vous)</small>';
                }

                tbody.innerHTML += `
                <tr>
                    <td>${u.email}</td>
                    <td><strong>${u.role.toUpperCase()}</strong></td>
                    <td>${btn}</td>
                </tr>`;
            });
        }

        async function setRole(uid, role) {
            if(!confirm('Changer le rÃ´le ?')) return;
            await sb.from('partenaires').update({ role: role }).eq('user_id', uid);
            loadAllUsers();
        }

        function showTab(id) {
            document.querySelectorAll('[id^="tab-"]').forEach(d => d.style.display='none');
            document.getElementById('tab-'+id).style.display='block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function openModalCar() { document.getElementById('modal-car').style.display='flex'; }

        // Lancement
        initAdmin();
    </script>
</body>
</html>
