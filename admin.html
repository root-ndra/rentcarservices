<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rent Cars Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- STYLES SPÃ‰CIFIQUES ADMIN --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        
        .admin-header { 
            background: white; padding: 15px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000;
        }

        .user-badge { display: flex; align-items: center; gap: 10px; }
        .role-indicator { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
        .role-admin { background: #e74c3c; }
        .role-partner { background: #3498db; }

        .admin-container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { padding: 12px 20px; border: none; background: none; font-weight: 600; color: #666; cursor: pointer; border-radius: 8px; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { background: #f0f2f5; }
        .tab-btn.active { background: #2c3e50; color: white; }

        /* VisibilitÃ© conditionnelle */
        .super-admin-only { display: none !important; }
        body.is-super-admin .super-admin-only { display: flex !important; }
        body.is-super-admin tr.super-admin-only { display: table-row !important; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:2000; }
        .modal-content { background:white; padding:30px; border-radius:15px; width:90%; max-width:600px; max-height: 90vh; overflow-y: auto; }
        
        #login-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#2c3e50; display:flex; justify-content:center; align-items:center; z-index:9999; }
        .login-box { background:white; padding:40px; border-radius:15px; width:350px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.ibb.co/dw8gxWXL/1765001359376.png" alt="Logo" style="width:100px; margin-bottom:20px;">
            <h2>Administration</h2>
            <input type="email" id="login-email" placeholder="Email" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <input type="password" id="login-pass" placeholder="Mot de passe" style="width:100%; padding:12px; margin-bottom:20px; border:1px solid #ddd; border-radius:8px;">
            <button onclick="connexion()" style="width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Se connecter</button>
            <p id="login-error" style="color:red; font-size:0.8rem; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <div class="admin-header">
        <div>
            <h1 style="margin:0; font-size:1.2rem;">PRO DASHBOARD</h1>
        </div>
        <div class="user-badge">
            <div style="text-align:right">
                <div id="user-email" style="font-weight:bold; font-size:0.9rem;">...</div>
                <div id="user-role-tag" class="role-indicator">...</div>
            </div>
            <button onclick="deconnexion()" style="background:#eee; border:none; padding:10px; border-radius:50%; cursor:pointer;"><i class="fas fa-power-off"></i></button>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="tab-btn" onclick="switchTab('reservations')"><i class="fas fa-calendar-alt"></i> RÃ©servations</button>
            <button class="tab-btn" onclick="switchTab('voitures')"><i class="fas fa-car"></i> Mes VÃ©hicules</button>
            <button class="tab-btn" onclick="switchTab('media')"><i class="fas fa-photo-video"></i> Media & Pubs</button>
            <button class="tab-btn super-admin-only" onclick="switchTab('users')"><i class="fas fa-users-cog"></i> Partenaires</button>
        </div>

        <div id="section-dashboard" class="admin-section">
            <div class="dashboard-grid" id="stats-container">
                </div>
            <div class="card" style="margin-top:20px;">
                <h3>Calendrier Global</h3>
                <div id="calendar-admin"></div>
            </div>
        </div>

        <div id="section-reservations" class="admin-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Liste des RÃ©servations</h2>
                <button onclick="exportResasPDF()" class="btn-dark"><i class="fas fa-file-pdf"></i> Exporter PDF</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>RÃ©f</th>
                        <th>Client</th>
                        <th>VÃ©hicule</th>
                        <th>Dates</th>
                        <th>Total</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="table-resas-body"></tbody>
            </table>
        </div>

        <div id="section-voitures" class="admin-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Ma Flotte</h2>
                <button onclick="ouvrirModalVoiture()" class="btn-dark">+ Ajouter un vÃ©hicule</button>
            </div>
            <div class="dashboard-grid" id="cars-admin-container" style="margin-top:20px;"></div>
        </div>

        <div id="section-media" class="admin-section" style="display:none;">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>PublicitÃ©s</h3>
                    <input type="text" id="pub-societe" placeholder="Nom SociÃ©tÃ©">
                    <input type="text" id="pub-image" placeholder="URL Image">
                    <input type="date" id="pub-debut" onchange="calculerFinPub()">
                    <input type="number" id="pub-duree" placeholder="Nb Jours" onchange="calculerFinPub()">
                    <input type="date" id="pub-fin" readonly>
                    <button onclick="ajouterPub()" class="btn-dark" style="width:100%; margin-top:10px;">Ajouter Pub</button>
                    <div id="list-pubs" style="margin-top:15px;"></div>
                </div>
                <div class="card">
                    <h3>Radios / Live</h3>
                    <select id="media-type"><option value="radios">Radio</option><option value="lives">Live Video</option></select>
                    <input type="text" id="media-nom" placeholder="Nom">
                    <input type="text" id="media-url" placeholder="URL Flux / Embed">
                    <input type="text" id="media-img" placeholder="URL Logo">
                    <button onclick="ajouterMedia()" class="btn-dark" style="width:100%; margin-top:10px;">Ajouter Media</button>
                </div>
            </div>
        </div>

        <div id="section-users" class="admin-section super-admin-only">
            <h2>Gestion des Partenaires & RÃ´les</h2>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Nom</th>
                        <th>RÃ´le</th>
                        <th>Date Inscription</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="table-users-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-voiture" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-voiture-title">Nouveau VÃ©hicule</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <input type="text" id="car-nom" placeholder="ModÃ¨le (ex: Toyota V8)">
                <input type="text" id="car-ref" placeholder="Immatriculation">
                <input type="number" id="car-prix" placeholder="Prix/Jour (Ar)">
                <select id="car-type">
                    <option value="Berline">Berline</option>
                    <option value="SUV / 4x4">SUV / 4x4</option>
                    <option value="Citadine">Citadine</option>
                </select>
                <input type="text" id="car-img" placeholder="URL Image Principale">
                <select id="car-reservable">
                    <option value="true">RÃ©servable en ligne</option>
                    <option value="false">Sur devis (Contact uniquement)</option>
                </select>
            </div>
            <textarea id="car-desc" placeholder="Description courte..." style="width:100%; margin-top:15px; height:80px;"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="sauvegarderVoiture()" class="btn-dark" style="flex:1">Enregistrer</button>
                <button onclick="fermerModal('modal-voiture')" style="flex:1; background:#ccc; border:none; border-radius:8px;">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE
        const SUPABASE_URL = 'https://ctijwjcjmbfmfhzwbguk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userSession = null;
        let userRole = 'partenaire';

        // --- AUTHENTIFICATION ---
        async function verifierSession() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                userSession = session.user;
                await recupererInfosPartenaire();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('user-email').innerText = userSession.email;
                initialiserDashboard();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }

        async function connexion() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
            if (error) {
                const errEl = document.getElementById('login-error');
                errEl.innerText = "Erreur : " + error.message;
                errEl.style.display = 'block';
            } else {
                window.location.reload();
            }
        }

        async function deconnexion() {
            await sb.auth.signOut();
            window.location.reload();
        }

        async function recupererInfosPartenaire() {
            // Chercher dans la table partenaire
            let { data: partenaire, error } = await sb
                .from('partenaires')
                .select('*')
                .eq('user_id', userSession.id)
                .single();

            // Si n'existe pas encore, crÃ©er le profil par dÃ©faut
            if (!partenaire && !error) {
                const { data: nouveau } = await sb.from('partenaires').insert([{
                    user_id: userSession.id,
                    email: userSession.email,
                    role: 'partenaire'
                }]).select().single();
                partenaire = nouveau;
            }

            userRole = partenaire ? partenaire.role : 'partenaire';
            const tag = document.getElementById('user-role-tag');
            tag.innerText = userRole === 'super_admin' ? 'Super Admin' : 'Partenaire';
            tag.className = 'role-indicator ' + (userRole === 'super_admin' ? 'role-admin' : 'role-partner');

            if (userRole === 'super_admin') {
                document.body.classList.add('is-super-admin');
            }
        }

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.getElementById('section-' + id).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            
            if(id === 'dashboard') chargerStats();
            if(id === 'reservations') chargerReservations();
            if(id === 'voitures') chargerFlotte();
            if(id === 'users' && userRole === 'super_admin') chargerPartenaires();
        }

        // --- LOGIQUE METIER ---
        async function initialiserDashboard() {
            chargerStats();
            initCalendar();
            chargerTablePubs();
        }

        async function chargerStats() {
            const container = document.getElementById('stats-container');
            // Si admin, compte tout. Si partenaire, compte seulement ses voitures/rÃ©sas
            let queryResas = sb.from('reservations').select('*', { count: 'exact' });
            let queryCars = sb.from('voitures').select('*', { count: 'exact' });

            if (userRole !== 'super_admin') {
                queryCars = queryCars.eq('proprietaire_id', userSession.id);
                // Pour les rÃ©sas partenaire, il faut filtrer par ses voitures
                const { data: myCars } = await sb.from('voitures').select('id').eq('proprietaire_id', userSession.id);
                const carIds = myCars.map(c => c.id);
                queryResas = queryResas.in('id_voiture', carIds);
            }

            const { count: countResas } = await queryResas;
            const { count: countCars } = await queryCars;

            container.innerHTML = `
                <div class="card" style="border-left: 5px solid #3498db;">
                    <h3>${countResas || 0}</h3>
                    <p>RÃ©servations totales</p>
                </div>
                <div class="card" style="border-left: 5px solid #2ecc71;">
                    <h3>${countCars || 0}</h3>
                    <p>VÃ©hicules en ligne</p>
                </div>
            `;
        }

        async function chargerReservations() {
            const tbody = document.getElementById('table-resas-body');
            let query = sb.from('reservations').select('*, voitures(nom)').order('created_at', { ascending: false });

            if (userRole !== 'super_admin') {
                const { data: myCars } = await sb.from('voitures').select('id').eq('proprietaire_id', userSession.id);
                query = query.in('id_voiture', myCars.map(c => c.id));
            }

            const { data: resas } = await query;
            tbody.innerHTML = resas.map(r => `
                <tr>
                    <td>#${r.id}</td>
                    <td>${r.nom}</td>
                    <td>${r.voitures ? r.voitures.nom : 'SupprimÃ©'}</td>
                    <td>${r.date_debut} au ${r.date_fin}</td>
                    <td>${r.montant_total} Ar</td>
                    <td><span class="status-badge">${r.statut}</span></td>
                    <td><button onclick="supprimerResa(${r.id})" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        async function chargerFlotte() {
            const container = document.getElementById('cars-admin-container');
            let query = sb.from('voitures').select('*');
            
            if (userRole !== 'super_admin') {
                query = query.eq('proprietaire_id', userSession.id);
            }

            const { data: cars } = await query;
            container.innerHTML = cars.map(c => `
                <div class="card">
                    <img src="${c.image_url}" style="width:100%; height:150px; object-fit:cover; border-radius:8px;">
                    <h4 style="margin:10px 0;">${c.nom}</h4>
                    <p><strong>Prix :</strong> ${c.prix_base} Ar/j</p>
                    <p><small>${c.reservable ? 'âœ… En ligne' : 'ðŸ“ž Contact'}</small></p>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="supprimerVoiture(${c.id})" class="btn-dark" style="background:#e74c3c; flex:1">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        // --- GESTION PARTENAIRES (SUPER ADMIN) ---
        async function chargerPartenaires() {
            const tbody = document.getElementById('table-users-body');
            const { data: users } = await sb.from('partenaires').select('*').order('created_at', { ascending: false });
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.email}</td>
                    <td>${u.nom || '-'}</td>
                    <td><span class="role-indicator ${u.role === 'super_admin' ? 'role-admin' : 'role-partner'}">${u.role}</span></td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                        <button onclick="changerRole(${u.id}, '${u.role === 'super_admin' ? 'partenaire' : 'super_admin'}')" class="btn-dark" style="font-size:0.7rem">
                            Switcher RÃ´le
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function changerRole(id, newRole) {
            if (!confirm("Changer le rÃ´le de cet utilisateur ?")) return;
            await sb.from('partenaires').update({ role: newRole }).eq('id', id);
            chargerPartenaires();
        }

        // --- FONCTIONS ACTIONS ---
        async function sauvegarderVoiture() {
            const voiture = {
                nom: document.getElementById('car-nom').value,
                ref_id: document.getElementById('car-ref').value,
                prix_base: parseInt(document.getElementById('car-prix').value),
                type: document.getElementById('car-type').value,
                image_url: document.getElementById('car-img').value,
                reservable: document.getElementById('car-reservable').value === 'true',
                description: document.getElementById('car-desc').value,
                proprietaire_id: userSession.id // Indispensable pour filtrer par la suite
            };

            const { error } = await sb.from('voitures').insert([voiture]);
            if(error) alert(error.message);
            else { alert("AjoutÃ© !"); fermerModal('modal-voiture'); chargerFlotte(); }
        }

        async function supprimerVoiture(id) {
            if(!confirm("Supprimer ce vÃ©hicule dÃ©finitivement ?")) return;
            await sb.from('voitures').delete().eq('id', id);
            chargerFlotte();
        }

        async function supprimerResa(id) {
            if(!confirm("Supprimer cette rÃ©servation ?")) return;
            await sb.from('reservations').delete().eq('id', id);
            chargerReservations();
        }

        // --- CALENDRIER & MISC ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar-admin');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                events: async function(info, successCallback) {
                    let query = sb.from('reservations').select('*, voitures(nom)');
                    if (userRole !== 'super_admin') {
                        const { data: myCars } = await sb.from('voitures').select('id').eq('proprietaire_id', userSession.id);
                        query = query.in('id_voiture', myCars.map(c => c.id));
                    }
                    const { data } = await query;
                    successCallback(data.map(r => ({
                        title: (r.voitures ? r.voitures.nom : 'Auto') + ' - ' + r.nom,
                        start: r.date_debut,
                        end: r.date_fin,
                        color: userRole === 'super_admin' ? '#2c3e50' : '#3498db'
                    })));
                }
            });
            calendar.render();
        }

        function calculerFinPub() {
             const days = parseInt(document.getElementById('pub-duree').value || 0);
             const deb = new Date(document.getElementById('pub-debut').value || new Date());
             deb.setDate(deb.getDate() + days);
             document.getElementById('pub-fin').value = deb.toISOString().split('T')[0];
        }

        async function ajouterPub() {
            const pub = {
                societe: document.getElementById('pub-societe').value,
                image_url: document.getElementById('pub-image').value,
                date_fin: document.getElementById('pub-fin').value,
                actif: true
            };
            await sb.from('pubs').insert([pub]);
            alert("Pub ajoutÃ©e"); chargerTablePubs();
        }

        async function chargerTablePubs() {
            const list = document.getElementById('list-pubs');
            const { data } = await sb.from('pubs').select('*');
            if(list && data) {
                list.innerHTML = data.map(p => `<div>â€¢ ${p.societe} (Fin: ${p.date_fin})</div>`).join('');
            }
        }

        function ouvrirModalVoiture() { document.getElementById('modal-voiture').style.display = 'flex'; }
        function fermerModal(id) { document.getElementById(id).style.display = 'none'; }

        // Initialisation au chargement
        verifierSession();

    </script>
</body>
</html>
