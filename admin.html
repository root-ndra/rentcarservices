<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rent Cars Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        .admin-header { background: white; padding: 15px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .user-profile-corner { display: flex; align-items: center; gap: 15px; }
        .user-role-badge { font-size: 0.75rem; color: #fff; background:#7f8c8d; padding: 2px 8px; border-radius: 4px; }

        .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .admin-tabs { display:flex; gap:10px; flex-wrap:wrap; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { padding:12px 20px; background:transparent; border:none; font-size:0.95rem; font-weight:600; color:#555; cursor:pointer; border-radius:6px; transition:0.3s; display:flex; align-items:center; gap:8px; }
        .tab-btn.active { background:#2c3e50; color:white; }
        .tab-btn.hidden { display: none !important; }

        .grid-dashboard { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:20px; }
        .car-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.05); position:relative; border-top:5px solid #2ecc71; }
        .card-header { padding:15px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; }
        .card-actions { padding:10px; background:#f8f9fa; border-top:1px solid #eee; display:flex; gap:5px; }
        .btn-action { flex:1; padding:8px; border:none; border-radius:5px; cursor:pointer; font-size:0.8rem; font-weight:600; }

        .table-container { background:white; border-radius:10px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.05); overflow-x:auto; margin-bottom:30px; }
        table { width:100%; border-collapse:collapse; min-width:900px; }
        th { background:#2c3e50; color:white; padding:15px; text-align:left; font-weight:600; font-size:0.9rem; white-space:nowrap; }
        td { padding:12px 15px; border-bottom:1px solid #eee; font-size:0.9rem; color:#333; vertical-align:top; }

        .form-box { background:white; padding:25px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd; box-shadow:0 2px 10px rgba(0,0,0,0.02); }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:15px; }
        .form-box input, .form-box select, .form-box textarea { width:100%; padding:12px; border:1px solid #ccc; border-radius:5px; font-size:1rem; box-sizing:border-box; }
        .section-title-admin { border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px; color:#2c3e50; }

        .login-wrapper { height:100vh; display:flex; justify-content:center; align-items:center; background:#2c3e50; padding:20px; }
        .login-box { background:white; padding:30px; border-radius:10px; width:100%; max-width:400px; text-align:center; }

        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:10px; width:90%; max-width:700px; position:relative; max-height:90vh; overflow-y:auto; }
        .close-modal { position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#777; }

        @media (max-width: 768px) {
            .admin-header { flex-direction:column; gap:15px; text-align:center; }
            .admin-tabs { overflow-x:auto; }
            .grid-dashboard { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

<div id="login-screen" class="login-wrapper">
    <div class="login-box">
        <h2>Accès Administrateur</h2>
        <p style="color:#777;">Connexion sécurisée Supabase</p>
        <input type="email" id="admin-email" placeholder="Email" style="width:100%; padding:15px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
        <input type="password" id="admin-pass" placeholder="Mot de passe" style="width:100%; padding:15px; margin-bottom:20px; border:1px solid #ccc; border-radius:5px;">
        <button onclick="loginAdmin()" id="btn-login" style="width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:5px; font-size:1.1rem; cursor:pointer;">
            Se connecter
        </button>
        <p id="login-error" style="color:red; margin-top:15px; display:none; font-size:0.9rem;"></p>
    </div>
</div>

<div id="admin-content" style="display:none;">
    <div class="admin-header">
        <div>
            <h1 style="margin:0;">Administration</h1>
            <small id="admin-header-subtext">Chargement...</small>
        </div>

        <div class="user-profile-corner">
            <div style="text-align:right;">
                <div id="header-user-name" style="font-weight:600;">Utilisateur</div>
                <span id="header-user-role" class="user-role-badge">...</span>
            </div>
            <button onclick="ouvrirModalProfil()" title="Profil" style="background:#ecf0f1; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">
                <i class="fas fa-user-cog"></i>
            </button>
            <button onclick="logoutAdmin()" title="Déconnexion" style="background:#c0392b; color:white; border:none; border-radius:5px; padding:10px 15px; cursor:pointer;">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-tabs">
            <button id="btn-tab-dashboard" class="tab-btn active" onclick="switchTab('dashboard', event)"><i class="fas fa-tachometer-alt"></i> Tableau de bord</button>
            <button id="btn-tab-reservations" class="tab-btn" onclick="switchTab('reservations', event)"><i class="fas fa-list-alt"></i> Réservations</button>
            <button id="btn-tab-partenaires" class="tab-btn" onclick="switchTab('partenaires', event)"><i class="fas fa-users-cog"></i> Partenaires</button>
            <button id="btn-tab-maintenances" class="tab-btn" onclick="switchTab('maintenances', event)"><i class="fas fa-tools"></i> Maintenances</button>
            <button id="btn-tab-promos" class="tab-btn" onclick="switchTab('promos', event)"><i class="fas fa-tags"></i> Codes promo</button>
            <button id="btn-tab-avis" class="tab-btn" onclick="switchTab('avis', event)"><i class="fas fa-star"></i> Avis</button>
            <button id="btn-tab-pubs" class="tab-btn" onclick="switchTab('pubs', event)"><i class="fas fa-ad"></i> Publicités</button>
            <button id="btn-tab-media" class="tab-btn" onclick="switchTab('media', event)"><i class="fas fa-music"></i> Divertissement</button>
            <button id="btn-tab-config" class="tab-btn" onclick="switchTab('config', event)"><i class="fas fa-cogs"></i> Configuration</button>
        </div>

        <!-- DASHBOARD -->
        <div id="view-dashboard">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <button onclick="ouvrirModalVoiture()" class="btn-publish" style="padding:10px 15px;"><i class="fas fa-plus-circle"></i> Ajouter une voiture</button>
                <div>
                    <span style="margin-right:10px; font-weight:bold;">Période :</span>
                    <button class="btn-action-small active" style="background:#2c3e50;" onclick="setPeriode('mois')">Ce mois</button>
                    <button class="btn-action-small" style="background:#95a5a6;" onclick="setPeriode('annee')">Cette année</button>
                </div>
            </div>
            <div id="grid-voitures" class="grid-dashboard"></div>
        </div>

        <!-- PARTENAIRES -->
        <div id="view-partenaires" style="display:none;">
            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-user-plus"></i> Gestion / Création partenaire</h3>
                <div class="form-grid">
                    <div><label>Nom</label><input type="text" id="part-nom"></div>
                    <div><label>Prénom</label><input type="text" id="part-prenom"></div>
                    <div><label>Email</label><input type="email" id="part-email"></div>
                    <div><label>Téléphone</label><input type="text" id="part-tel"></div>
                    <div><label>Durée contrat</label>
                        <select id="part-duree" onchange="calculerFinContrat()">
                            <option value="30">1 mois</option>
                            <option value="90">3 mois</option>
                            <option value="180">6 mois</option>
                            <option value="365" selected>1 an</option>
                        </select>
                    </div>
                    <div><label>Fin contrat</label><input type="date" id="part-fin" readonly style="background:#eee;"></div>
                    <div><label>Commission (%)</label>
                        <select id="part-royalties">
                            <option value="5">5%</option>
                            <option value="10">10%</option>
                            <option value="15" selected>15%</option>
                            <option value="20">20%</option>
                        </select>
                    </div>
                </div>
                <button onclick="upsertPartenaire()" class="btn-publish" style="width:100%; margin-top:10px;">Enregistrer</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nom</th><th>Contact</th><th>Contrat</th><th>Commission</th><th>Statut</th><th>Actions</th></tr></thead>
                    <tbody id="tbody-partenaires"></tbody>
                </table>
            </div>
        </div>

        <!-- RÉSERVATIONS -->
        <div id="view-reservations" style="display:none;">
            <button onclick="toggleNewResaForm()" style="margin-bottom:15px; background:#2ecc71; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">
                <i class="fas fa-plus-circle"></i> Nouvelle réservation (comptoir)
            </button>
            <div id="form-new-resa" class="form-box" style="display:none; background:#e8f8f5;">
                <h3 class="section-title-admin">Création réservation</h3>
                <div class="form-grid">
                    <div><label>Voiture</label><select id="new-resa-voiture" onchange="calculerPrixAdmin()"></select></div>
                    <div><label>Client (Nom)</label><input type="text" id="new-resa-nom"></div>
                    <div><label>Client (Tel)</label><input type="text" id="new-resa-tel"></div>
                    <div><label>Début</label><input type="date" id="new-resa-debut" onchange="calculerPrixAdmin()"></div>
                    <div><label>Fin</label><input type="date" id="new-resa-fin" onchange="calculerPrixAdmin()"></div>
                    <div><label>Lieu Livraison</label><input type="text" id="new-resa-liv-lieu"></div>
                    <div><label>Heure Livraison</label><input type="time" id="new-resa-liv-heure"></div>
                    <div><label>Lieu Récupération</label><input type="text" id="new-resa-rec-lieu"></div>
                    <div><label>Heure Récupération</label><input type="time" id="new-resa-rec-heure"></div>
                    <div><label>Trajet (texte libre)</label><input type="text" id="new-resa-trajet"></div>
                    <div><label>Montant (Ar)</label><input type="number" id="new-resa-montant" onchange="updateResteAdmin()"></div>
                    <div><label>Déjà payé (Ar)</label><input type="number" id="new-resa-paye" value="0" onchange="updateResteAdmin()"></div>
                    <div><label>Reste (Ar)</label><input type="number" id="new-resa-reste" readonly style="background:#ddd;"></div>
                    <div><label>Statut</label><select id="new-resa-statut"><option value="valide">Validé</option><option value="en_attente">En attente</option></select></div>
                </div>
                <button onclick="creerReservationAdmin()" class="btn-publish" style="width:100%; margin-top:15px;">Créer</button>
            </div>

            <div class="table-container">
                <table id="table-resa-full">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>Client</th>
                            <th>Voiture / Dates</th>
                            <th>Logistique & Trajet</th>
                            <th>Paiement</th>
                            <th>OTP / Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-resa-full"></tbody>
                </table>
            </div>
        </div>

        <!-- MAINTENANCES -->
        <div id="view-maintenances" style="display:none;">
            <div class="table-container">
                <table>
                    <thead><tr><th>Date</th><th>Voiture</th><th>Type</th><th>Détails</th><th>Coût</th><th>Actions</th></tr></thead>
                </table>
                <tbody id="tbody-maint-global"></tbody>
            </div>
        </div>

        <!-- PROMOS -->
        <div id="view-promos" style="display:none;">
            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-tag"></i> Nouveau code promo</h3>
                <div class="form-grid">
                    <div><label>Code</label><input type="text" id="promo-code" placeholder="EX: ETE2024"></div>
                    <div><label>Réduction (%)</label><input type="number" id="promo-pourcent"></div>
                    <div><label>Min. jours</label><input type="number" id="promo-jours" value="1"></div>
                    <div><label>Date début</label><input type="date" id="promo-debut"></div>
                    <div><label>Date fin</label><input type="date" id="promo-fin"></div>
                </div>
                <button onclick="ajouterPromo()" class="btn-publish" style="width:100%; margin-top:10px;">Créer</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Code</th><th>Réduction</th><th>Validité</th><th>Conditions</th><th>Actions</th></tr></thead>
                    <tbody id="tbody-promos"></tbody>
                </table>
            </div>
        </div>

        <!-- AVIS -->
        <div id="view-avis" style="display:none;">
            <div class="table-container">
                <table>
                    <thead><tr><th>Date</th><th>Client</th><th>Note</th><th>Commentaire</th><th>Statut</th><th>Action</th></tr></thead>
                    <tbody id="tbody-avis"></tbody>
                </table>
            </div>
        </div>

        <!-- PUBLICITÉS -->
        <div id="view-pubs" style="display:none;">
            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-ad"></i> Ajouter une publicité</h3>
                <div class="form-grid">
                    <div><label>Société</label><input type="text" id="pub-societe"></div>
                    <div><label>Contact</label><input type="text" id="pub-contact"></div>
                    <div><label>Emplacement</label>
                        <select id="pub-emplacement">
                            <option value="home_top">Accueil Haut</option>
                            <option value="home_bot">Accueil Bas</option>
                            <option value="flotte_top">Voitures Haut</option>
                            <option value="flotte_bot">Voitures Bas</option>
                            <option value="media_top">Divertissement Haut</option>
                            <option value="media_bot">Divertissement Bas</option>
                        </select>
                    </div>
                    <div><label>Image (URL)</label><input type="text" id="pub-image"></div>
                    <div><label>Lien</label><input type="text" id="pub-lien"></div>
                    <div><label>Date début</label><input type="date" id="pub-debut" onchange="calculerFinPub()"></div>
                    <div><label>Durée</label>
                        <select id="pub-duree" onchange="calculerFinPub()">
                            <option value="7">7 jours</option>
                            <option value="15">15 jours</option>
                            <option value="30" selected>1 mois</option>
                            <option value="90">3 mois</option>
                        </select>
                    </div>
                    <div><label>Date fin</label><input type="date" id="pub-fin" readonly style="background:#eee;"></div>
                </div>
                <button onclick="ajouterPub()" class="btn-publish" style="margin-top:15px; width:100%;">Enregistrer</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Société</th><th>Emplacement</th><th>Période</th><th>Image</th><th>Statut</th><th>Actions</th></tr></thead>
                    <tbody id="tbody-pubs"></tbody>
                </table>
            </div>
        </div>

        <!-- MEDIA -->
        <div id="view-media" style="display:none;">
            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-broadcast-tower"></i> Ajouter une radio</h3>
                <div class="form-grid">
                    <div><label>Nom</label><input type="text" id="rad-nom"></div>
                    <div><label>Flux</label><input type="text" id="rad-url"></div>
                    <div><label>Logo (URL)</label><input type="text" id="rad-logo"></div>
                </div>
                <button onclick="ajouterRadio()" class="btn-publish" style="margin-top:15px; width:100%;">Ajouter</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Logo</th><th>Nom</th><th>Flux</th><th>Statut</th><th>Action</th></tr></thead>
                    <tbody id="tbody-radios"></tbody>
                </table>
            </div>

            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-music"></i> Playlists</h3>
                <div class="form-grid">
                    <div><label>Titre</label><input type="text" id="play-titre"></div>
                    <div><label>Plateforme</label>
                        <select id="play-plateforme">
                            <option value="youtube">YouTube</option>
                            <option value="spotify">Spotify</option>
                            <option value="deezer">Deezer</option>
                        </select>
                    </div>
                    <div><label>Lien embed</label><input type="text" id="play-url"></div>
                </div>
                <button onclick="ajouterPlaylist()" class="btn-publish" style="margin-top:15px; width:100%;">Ajouter</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Plateforme</th><th>Titre</th><th>Lien</th><th>Statut</th><th>Action</th></tr></thead>
                    <tbody id="tbody-playlists"></tbody>
                </table>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="view-config" style="display:none;">
            <div class="form-box">
                <h3 class="section-title-admin"><i class="fas fa-cogs"></i> Paramètres</h3>
                <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:20px;">
                    <div>
                        <h4 style="margin:0 0 5px 0;">Affichage du calendrier (site public)</h4>
                        <p style="margin:0; color:#666; font-size:0.9rem;">Activer/désactiver le calendrier sur la page d’accueil.</p>
                    </div>
                    <label style="display:flex; align-items:center; gap:10px;">
                        <span id="status-calendar-text" style="font-weight:bold;">VISIBLE</span>
                        <input type="checkbox" id="toggle-calendar-global" checked onchange="toggleGlobalCalendar()">
                    </label>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- MODALES -->
<div id="modal-voiture" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="fermerModal('modal-voiture')">×</span>
        <h3>Ajout / édition voiture</h3>
        <div class="form-grid">
            <div><label>Nom / Modèle</label><input id="new-car-nom"></div>
            <div><label>Prix (Ar/jour)</label><input id="new-car-prix" type="number"></div>
            <div><label>Places</label><input id="new-car-places" type="number" value="5"></div>
            <div><label>Transmission</label>
                <select id="new-car-trans"><option>Manuelle</option><option>Automatique</option></select>
            </div>
            <div><label>Carburant</label>
                <select id="new-car-carburant"><option>Essence</option><option>Diesel</option><option>Hybride</option><option>Electrique</option></select>
            </div>
            <div><label>Type</label>
                <select id="new-car-type"><option>Citadine</option><option>Berline</option><option>SUV</option><option>4x4</option><option>Minibus</option></select>
            </div>
            <div><label>Réservable ?</label>
                <select id="new-car-reservable"><option value="true">Oui</option><option value="false">Non (contact direct)</option></select>
            </div>
            <div style="grid-column:span 2;"><label>Description</label><textarea id="new-car-desc" rows="2"></textarea></div>
            <div style="grid-column:span 2;"><label>Image principale (URL)</label><input id="new-car-img"></div>
            <div style="grid-column:span 2;"><label>Référence interne</label><input id="new-car-ref"></div>
        </div>
        <button onclick="ajouterVoiture()" class="btn-publish" style="width:100%; margin-top:10px;">Enregistrer</button>
    </div>
</div>

<div id="modal-profil" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="fermerModal('modal-profil')">×</span>
        <h3>Profil</h3>
        <p>Connecté via Supabase.</p>
    </div>
</div>

<script src="script.js"></script>
<script>
const ROLE_SUPER_ADMIN = 'super_admin';
const ROLE_PARTENAIRE = 'partenaire';
const restrictedTabs = ['partenaires','promos','pubs','media','config'];
let currentUserRole = null;
let currentUser = null;
let globalVoitures = [];
let periodeAnalyse = 'mois';

async function loginAdmin() {
    const email = document.getElementById('admin-email').value.trim();
    const password = document.getElementById('admin-pass').value.trim();
    const errorMsg = document.getElementById('login-error');
    errorMsg.style.display = 'none';

    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
        errorMsg.innerText = error.message;
        errorMsg.style.display = 'block';
    } else {
        verifierSession();
    }
}

async function logoutAdmin() {
    await sb.auth.signOut();
    window.location.reload();
}

async function chargerRoleUtilisateur(userId) {
    const { data, error } = await sb.from('partenaires').select('role').eq('user_id', userId).maybeSingle();
    if (error) {
        console.warn('Impossible de charger le rôle', error);
        currentUserRole = ROLE_PARTENAIRE;
    } else {
        currentUserRole = data?.role || ROLE_PARTENAIRE;
    }
    return currentUserRole;
}

function appliquerInterfaceSelonRole() {
    const label = document.getElementById('header-user-role');
    const roleText = currentUserRole === ROLE_SUPER_ADMIN ? 'SUPER ADMIN' : 'PARTENAIRE';
    label.innerText = roleText;
    label.style.background = currentUserRole === ROLE_SUPER_ADMIN ? '#27ae60' : '#7f8c8d';

    restrictedTabs.forEach((tab) => {
        const btn = document.getElementById(`btn-tab-${tab}`);
        if (!btn) return;
        btn.classList.toggle('hidden', currentUserRole !== ROLE_SUPER_ADMIN);
    });

    if (currentUserRole !== ROLE_SUPER_ADMIN) {
        switchTab('dashboard');
    }
}

async function verifierSession() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('admin-content').style.display = 'none';
        return;
    }

    currentUser = session.user;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-content').style.display = 'block';
    document.getElementById('header-user-name').innerText = currentUser.email;

    await chargerRoleUtilisateur(currentUser.id);
    appliquerInterfaceSelonRole();
    chargerConfigAdmin();
    chargerDashboard();
}

function switchTab(tabName, evt) {
    if (currentUserRole !== ROLE_SUPER_ADMIN && restrictedTabs.includes(tabName)) {
        alert('Section réservée au Super Admin.');
        return;
    }
    ['dashboard','reservations','maintenances','avis','pubs','media','promos','partenaires','config'].forEach((t) => {
        const view = document.getElementById(`view-${t}`);
        if (view) view.style.display = t === tabName ? 'block' : 'none';
    });
    document.querySelectorAll('.tab-btn').forEach((btn) => btn.classList.remove('active'));
    if (evt?.currentTarget) evt.currentTarget.classList.add('active');

    if (tabName === 'reservations') { chargerVoituresPourSelect(); chargerTableReservations(); }
    if (tabName === 'maintenances') chargerTableMaintenances();
    if (tabName === 'promos') chargerTablePromos();
    if (tabName === 'partenaires') chargerTablePartenaires();
    if (tabName === 'avis') chargerTableAvis();
    if (tabName === 'pubs') chargerTablePubs();
    if (tabName === 'media') chargerTableMedia();
    if (tabName === 'config') chargerConfigAdmin();
}

async function chargerConfigAdmin() {
    try {
        const response = await fetch('site_config.json');
        const config = await response.json();
        document.getElementById('admin-header-subtext').innerText = `Gestion ${config.header.siteName}`;
        document.title = `Admin - ${config.header.siteName}`;
    } catch (e) {
        console.warn('Config admin', e);
    }

    const toggle = document.getElementById('toggle-calendar-global');
    const txt = document.getElementById('status-calendar-text');
    const { data } = await sb.from('config_site').select('value').eq('key', 'calendar_visible').maybeSingle();
    const visible = data?.value === true || data?.value === 'true';
    toggle.checked = visible;
    txt.innerText = visible ? 'VISIBLE' : 'MASQUÉ';
    txt.style.color = visible ? '#27ae60' : '#e74c3c';
}

async function chargerDashboard() {
    const grid = document.getElementById('grid-voitures');
    grid.innerHTML = '<p>Chargement...</p>';

    let query = sb.from('voitures').select('*').order('created_at', { ascending: false });
    if (currentUserRole !== ROLE_SUPER_ADMIN) query = query.eq('proprietaire_id', currentUser.id);

    const { data, error } = await query;
    if (error) {
        grid.innerHTML = `<p>Erreur: ${error.message}</p>`;
        return;
    }
    globalVoitures = data || [];
    if (!globalVoitures.length) {
        grid.innerHTML = '<p>Aucune voiture.</p>';
        return;
    }

    grid.innerHTML = '';
    globalVoitures.forEach((v) => {
        const card = document.createElement('div');
        card.className = 'car-card';
        const isReservable = v.reservable !== false;
        card.innerHTML = `
            <div class="card-header">
                <strong>${v.nom}</strong>
                <span class="badge ${isReservable ? 'bg-green' : 'bg-orange'}">${isReservable ? 'DISPO' : 'CONTACT'}</span>
            </div>
            <div class="card-body">
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:#555;">
                    <span><i class="fas fa-hashtag"></i> ${v.ref_id || '-'}</span>
                    <span>${v.transmission || ''}</span>
                </div>
            </div>
            <div class="card-actions">
                <button class="btn-action btn-edit" onclick="toggleReservable('${v.id}', ${isReservable})">
                    <i class="${isReservable ? 'fas fa-toggle-on' : 'fas fa-toggle-off'}"></i> ${isReservable ? 'Rendre indisponible' : 'Activer'}
                </button>
            </div>`;
        grid.appendChild(card);
    });
}

async function toggleReservable(id, currentVal) {
    const newVal = !currentVal;
    if (!confirm(`Passer ce véhicule en ${newVal ? 'RÉSERVABLE' : 'CONTACT SEUL'} ?`)) return;
    const { error } = await sb.from('voitures').update({ reservable: newVal }).eq('id', id);
    if (error) alert(error.message);
    else chargerDashboard();
}

function ouvrirModalVoiture() {
    document.getElementById('modal-voiture').style.display = 'flex';
}
function fermerModal(id) {
    document.getElementById(id).style.display = 'none';
}

async function ajouterVoiture() {
    const { data: { user } } = await sb.auth.getUser();
    const nom = document.getElementById('new-car-nom').value.trim();
    const prix = parseInt(document.getElementById('new-car-prix').value, 10);
    if (!nom || !prix) return alert('Nom et prix requis');

    const voiture = {
        nom,
        prix_base: prix,
        places: parseInt(document.getElementById('new-car-places').value, 10) || null,
        transmission: document.getElementById('new-car-trans').value,
        carburant: document.getElementById('new-car-carburant').value,
        type: document.getElementById('new-car-type').value,
        description: document.getElementById('new-car-desc').value,
        image_url: document.getElementById('new-car-img').value,
        ref_id: document.getElementById('new-car-ref').value,
        reservable: document.getElementById('new-car-reservable').value === 'true',
        proprietaire_id: user.id,
    };

    const { error } = await sb.from('voitures').insert([voiture]);
    if (error) alert(error.message);
    else {
        fermerModal('modal-voiture');
        chargerDashboard();
    }
}

function toggleNewResaForm() {
    const f = document.getElementById('form-new-resa');
    f.style.display = f.style.display === 'none' ? 'block' : 'none';
}
function calculerPrixAdmin() {
    const debut = document.getElementById('new-resa-debut').value;
    const fin = document.getElementById('new-resa-fin').value;
    const select = document.getElementById('new-resa-voiture');
    const prix = select.options[select.selectedIndex]?.dataset?.prix;
    if (!debut || !fin || !prix) return;
    const diff = (new Date(fin) - new Date(debut)) / 86400000 + 1;
    const montant = diff * parseInt(prix, 10);
    document.getElementById('new-resa-montant').value = montant;
    updateResteAdmin();
}
function updateResteAdmin() {
    const total = parseInt(document.getElementById('new-resa-montant').value, 10) || 0;
    const paye = parseInt(document.getElementById('new-resa-paye').value, 10) || 0;
    document.getElementById('new-resa-reste').value = Math.max(total - paye, 0);
}

async function chargerVoituresPourSelect() {
    const sel = document.getElementById('new-resa-voiture');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Sélection --</option>';

    let query = sb.from('voitures').select('id, nom, prix_base, proprietaire_id').order('nom', { ascending: true });
    if (currentUserRole !== ROLE_SUPER_ADMIN) query = query.eq('proprietaire_id', currentUser.id);

    const { data } = await query;
    (data || []).forEach((v) => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.text = `${v.nom} (${formatPrix(v.prix_base)} Ar)`;
        opt.dataset.prix = v.prix_base;
        opt.dataset.owner = v.proprietaire_id;
        sel.appendChild(opt);
    });
}

async function creerReservationAdmin() {
    const select = document.getElementById('new-resa-voiture');
    const vid = select.value;
    if (!vid) return alert('Choisissez une voiture.');

    const voitureOwner = select.options[select.selectedIndex].dataset.owner || currentUser.id;

    const reservation = {
        id_voiture: vid,
        nom: document.getElementById('new-resa-nom').value || 'Client Comptoir',
        tel: document.getElementById('new-resa-tel').value || '',
        date_debut: document.getElementById('new-resa-debut').value,
        date_fin: document.getElementById('new-resa-fin').value,
        montant_total: parseInt(document.getElementById('new-resa-montant').value, 10) || 0,
        paiement_montant_declare: parseInt(document.getElementById('new-resa-paye').value, 10) || 0,
        statut: document.getElementById('new-resa-statut').value,
        lieu_livraison: document.getElementById('new-resa-liv-lieu').value,
        heure_livraison: document.getElementById('new-resa-liv-heure').value,
        lieu_recuperation: document.getElementById('new-resa-rec-lieu').value,
        heure_recuperation: document.getElementById('new-resa-rec-heure').value,
        trajet_details: document.getElementById('new-resa-trajet').value,
        partenaire_id: voitureOwner,
    };

    if (!reservation.date_debut || !reservation.date_fin) return alert('Dates requises');

    const { error } = await sb.from('reservations').insert([reservation]);
    if (error) alert(error.message);
    else {
        toggleNewResaForm();
        chargerTableReservations();
    }
}

async function chargerTableReservations() {
    const tbody = document.getElementById('tbody-resa-full');
    tbody.innerHTML = '<tr><td colspan="7">Chargement...</td></tr>';

    let query = sb
        .from('reservations')
        .select('*, voitures(id, nom, proprietaire_id)')
        .order('created_at', { ascending: false });

    if (currentUserRole !== ROLE_SUPER_ADMIN) {
        query = query.eq('partenaire_id', currentUser.id);
    }

    const { data, error } = await query;
    if (error) {
        tbody.innerHTML = `<tr><td colspan="7">Erreur: ${error.message}</td></tr>`;
        return;
    }
    if (!data?.length) {
        tbody.innerHTML = '<tr><td colspan="7">Aucune réservation.</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    data.forEach((r) => {
        const reste = (r.montant_total || 0) - (r.paiement_montant_declare || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>#${r.id}</td>
            <td>${r.nom || '-'}<br><small>${r.tel || ''}</small></td>
            <td>${r.voitures?.nom || '-'}<br><small>${r.date_debut} → ${r.date_fin}</small></td>
            <td>
                <strong>Livraison:</strong> ${r.lieu_livraison || '-'} (${r.heure_livraison || '-'})<br>
                <strong>Retour:</strong> ${r.lieu_recuperation || '-'} (${r.heure_recuperation || '-'})<br>
                <strong>Trajet:</strong> ${r.trajet_details || '-'}
            </td>
            <td>
                ${r.paiement_methode || '-'}<br>
                Ref: ${r.paiement_ref || '-'}<br>
                Payé: ${formatPrix(r.paiement_montant_declare || 0)} Ar<br>
                <strong style="color:${reste > 0 ? 'red' : 'green'};">Reste: ${formatPrix(reste)} Ar</strong>
            </td>
            <td>
                OTP: <strong>${r.code_otp || '-'}</strong><br>
                <select onchange="updateStatutResa('${r.id}', this.value)">
                    <option value="en_attente" ${r.statut === 'en_attente' ? 'selected' : ''}>En attente</option>
                    <option value="valide" ${r.statut === 'valide' ? 'selected' : ''}>Validé</option>
                    <option value="annulee" ${r.statut === 'annulee' ? 'selected' : ''}>Annulé</option>
                </select>
            </td>
            <td>
                <button class="btn-action-small btn-publish" onclick="genererOTP('${r.id}')">Générer OTP</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

async function updateStatutResa(id, statut) {
    await sb.from('reservations').update({ statut }).eq('id', id);
}

async function genererOTP(id) {
    const code = Math.floor(1000 + Math.random() * 9000);
    const { error } = await sb.from('reservations').update({ code_otp: code, statut: 'valide' }).eq('id', id);
    if (error) alert(error.message);
    else {
        alert(`OTP ${code} généré`);
        chargerTableReservations();
    }
}

async function chargerTableMaintenances() {
    const tbody = document.getElementById('tbody-maint-global');
    if (!tbody) return;
    tbody.innerHTML = '<tr><td colspan="6">Chargement...</td></tr>';

    let query = sb
        .from('maintenances')
        .select('*, voitures!inner(id, nom, proprietaire_id)')
        .order('date_debut', { ascending: false });

    if (currentUserRole !== ROLE_SUPER_ADMIN) {
        query = query.eq('voitures.proprietaire_id', currentUser.id);
    }

    const { data, error } = await query;
    if (error) {
        tbody.innerHTML = `<tr><td colspan="6">Erreur: ${error.message}</td></tr>`;
        return;
    }
    if (!data?.length) {
        tbody.innerHTML = '<tr><td colspan="6">Aucune maintenance.</td></tr>';
        return;
    }
    tbody.innerHTML = data
        .map(
            (m) => `
            <tr>
                <td>${m.date_debut}</td>
                <td>${m.voitures?.nom || '-'}</td>
                <td>${m.type_intervention || '-'}</td>
                <td>${m.details || '-'}</td>
                <td>${formatPrix(m.cout || 0)} Ar</td>
                <td>-</td>
            </tr>`
        )
        .join('');
}

async function chargerTablePartenaires() {
    if (currentUserRole !== ROLE_SUPER_ADMIN) return;
    const tbody = document.getElementById('tbody-partenaires');
    tbody.innerHTML = '<tr><td colspan="6">Chargement...</td></tr>';

    const { data, error } = await sb.from('partenaires').select('*').order('created_at', { ascending: false });
    if (error) {
        tbody.innerHTML = `<tr><td colspan="6">Erreur: ${error.message}</td></tr>`;
        return;
    }
    if (!data?.length) {
        tbody.innerHTML = '<tr><td colspan="6">Aucun partenaire.</td></tr>';
        return;
    }
    tbody.innerHTML = data
        .map(
            (p) => `
            <tr>
                <td>${p.nom_complet || `${p.nom || ''} ${p.prenom || ''}`}</td>
                <td>${p.email}<br>${p.telephone || ''}</td>
                <td>${p.date_fin_contrat || '-'}</td>
                <td>${p.commission_taux || 0}%</td>
                <td>${p.est_gele ? 'Gelé' : 'Actif'}</td>
                <td>-</td>
            </tr>`
        )
        .join('');
}

function calculerFinContrat() {
    const days = parseInt(document.getElementById('part-duree').value, 10);
    const date = new Date();
    date.setDate(date.getDate() + days);
    document.getElementById('part-fin').value = date.toISOString().split('T')[0];
}

async function upsertPartenaire() {
    if (currentUserRole !== ROLE_SUPER_ADMIN) return;
    const payload = {
        email: document.getElementById('part-email').value,
        nom: document.getElementById('part-nom').value,
        prenom: document.getElementById('part-prenom').value,
        tel: document.getElementById('part-tel').value,
        fin_contrat: document.getElementById('part-fin').value,
        royalties: document.getElementById('part-royalties').value,
    };
    if (!payload.email) return alert('Email requis');
    const { error } = await sb.from('partenaires').insert([payload]);
    if (error) alert(error.message);
    else chargerTablePartenaires();
}

// PROMOS
async function ajouterPromo() {
    const code = document.getElementById('promo-code').value.toUpperCase();
    if (!code) return alert('Code requis');
    const payload = {
        code,
        reduction_pourcent: parseInt(document.getElementById('promo-pourcent').value, 10) || 0,
        min_jours: parseInt(document.getElementById('promo-jours').value, 10) || 1,
        date_debut: document.getElementById('promo-debut').value,
        date_fin: document.getElementById('promo-fin').value,
        actif: true,
    };
    const { error } = await sb.from('codes_promo').insert([payload]);
    if (error) alert(error.message);
    else chargerTablePromos();
}
async function chargerTablePromos() {
    const tbody = document.getElementById('tbody-promos');
    tbody.innerHTML = '<tr><td colspan="5">Chargement...</td></tr>';
    const { data, error } = await sb.from('codes_promo').select('*').order('date_debut', { ascending: true });
    if (error) {
        tbody.innerHTML = `<tr><td colspan="5">Erreur: ${error.message}</td></tr>`;
        return;
    }
    tbody.innerHTML = (data || [])
        .map(
            (p) => `
        <tr>
            <td>${p.code}</td>
            <td>${p.reduction_pourcent}%</td>
            <td>${p.date_debut} → ${p.date_fin}</td>
            <td>${p.min_jours} jours min.</td>
            <td>${p.actif ? 'Actif' : 'Inactif'}</td>
        </tr>`
        )
        .join('');
}

// AVIS
async function chargerTableAvis() {
    const tbody = document.getElementById('tbody-avis');
    const { data, error } = await sb.from('avis').select('*').order('created_at', { ascending: false });
    if (error) {
        tbody.innerHTML = `<tr><td colspan="6">Erreur: ${error.message}</td></tr>`;
        return;
    }
    tbody.innerHTML = (data || [])
        .map(
            (a) => `
        <tr>
            <td>${new Date(a.created_at).toLocaleDateString('fr-FR')}</td>
            <td>${a.nom}</td>
            <td>${a.note}/5</td>
            <td>${a.commentaire}</td>
            <td>${a.visible ? 'Visible' : 'Masqué'}</td>
            <td><button class="btn-action-small btn-edit" onclick="toggleAvis(${a.id}, ${a.visible})">Basculer</button></td>
        </tr>`
        )
        .join('');
}
async function toggleAvis(id, current) {
    await sb.from('avis').update({ visible: !current }).eq('id', id);
    chargerTableAvis();
}

// PUBLICITÉS
function calculerFinPub() {
    const debut = document.getElementById('pub-debut').value;
    if (!debut) return;
    const days = parseInt(document.getElementById('pub-duree').value, 10);
    const d = new Date(debut);
    d.setDate(d.getDate() + days);
    document.getElementById('pub-fin').value = d.toISOString().split('T')[0];
}
async function ajouterPub() {
    const payload = {
        societe: document.getElementById('pub-societe').value,
        contact: document.getElementById('pub-contact').value,
        emplacement: document.getElementById('pub-emplacement').value,
        image_url: document.getElementById('pub-image').value,
        lien_redirection: document.getElementById('pub-lien').value,
        date_debut: document.getElementById('pub-debut').value,
        date_fin: document.getElementById('pub-fin').value,
        actif: true,
    };
    const { error } = await sb.from('publicites').insert([payload]);
    if (error) alert(error.message);
    else chargerTablePubs();
}
async function chargerTablePubs() {
    const tbody = document.getElementById('tbody-pubs');
    const { data, error } = await sb.from('publicites').select('*').order('date_debut', { ascending: false });
    if (error) {
        tbody.innerHTML = `<tr><td colspan="6">Erreur: ${error.message}</td></tr>`;
        return;
    }
    tbody.innerHTML = (data || [])
        .map(
            (p) => `
        <tr>
            <td>${p.societe}</td>
            <td>${p.emplacement}</td>
            <td>${p.date_debut} → ${p.date_fin}</td>
            <td><img src="${p.image_url}" alt="${p.societe}" style="width:60px; height:60px; object-fit:cover;"></td>
            <td>${p.actif ? 'Actif' : 'Inactif'}</td>
            <td>-</td>
        </tr>`
        )
        .join('');
}

// MEDIA
async function ajouterRadio() {
    const payload = { nom: document.getElementById('rad-nom').value, url_flux: document.getElementById('rad-url').value, image_url: document.getElementById('rad-logo').value, actif: true };
    await sb.from('radios').insert([payload]);
    chargerTableMedia();
}
async function ajouterPlaylist() {
    const payload = { titre: document.getElementById('play-titre').value, plateforme: document.getElementById('play-plateforme').value, url_embed: document.getElementById('play-url').value, actif: true };
    await sb.from('playlists').insert([payload]);
    chargerTableMedia();
}
async function chargerTableMedia() {
    const radios = await sb.from('radios').select('*').order('created_at', { ascending: false });
    const tbodyRadios = document.getElementById('tbody-radios');
    tbodyRadios.innerHTML = (radios.data || [])
        .map(
            (r) => `
        <tr>
            <td><img src="${r.image_url}" style="width:40px; height:40px; object-fit:contain;"></td>
            <td>${r.nom}</td>
            <td>${r.url_flux}</td>
            <td>${r.actif ? 'Actif' : 'Inactif'}</td>
            <td>-</td>
        </tr>`
        )
        .join('');

    const playlists = await sb.from('playlists').select('*').order('created_at', { ascending: false });
    const tbodyPlay = document.getElementById('tbody-playlists');
    tbodyPlay.innerHTML = (playlists.data || [])
        .map(
            (p) => `
        <tr>
            <td>${p.plateforme}</td>
            <td>${p.titre}</td>
            <td>${p.url_embed}</td>
            <td>${p.actif ? 'Actif' : 'Inactif'}</td>
            <td>-</td>
        </tr>`
        )
        .join('');
}

async function toggleGlobalCalendar() {
    if (currentUserRole !== ROLE_SUPER_ADMIN) {
        alert('Réservé au Super Admin.');
        document.getElementById('toggle-calendar-global').checked = !document.getElementById('toggle-calendar-global').checked;
        return;
    }
    const toggle = document.getElementById('toggle-calendar-global');
    const value = toggle.checked;
    await sb.from('config_site').upsert({ key: 'calendar_visible', value });
    document.getElementById('status-calendar-text').innerText = value ? 'VISIBLE' : 'MASQUÉ';
    document.getElementById('status-calendar-text').style.color = value ? '#27ae60' : '#e74c3c';
}

function ouvrirModalProfil() {
    document.getElementById('modal-profil').style.display = 'flex';
}

function setPeriode(p) {
    periodeAnalyse = p;
}

verifierSession();
</script>
</body>
</html>
