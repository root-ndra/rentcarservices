<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rija Cars</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- STYLES SP√âCIFIQUES ADMIN --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        
        .admin-header { 
            background: white; padding: 15px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 100;
        }
        .user-profile-corner { display: flex; align-items: center; gap: 15px; }
        .user-name-display { font-weight: bold; color: #2c3e50; text-align: right; line-height: 1.2; }
        .user-role-badge { font-size: 0.75rem; color: #7f8c8d; font-weight: normal; }
        
        .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Onglets */
        .admin-tabs { 
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn { 
            padding: 12px 20px; background: transparent; border: none; font-size: 0.95rem; 
            font-weight: 600; color: #555; cursor: pointer; border-radius: 6px; transition: 0.3s; 
            display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .tab-btn:hover { background: #f0f0f0; color: #2c3e50; }
        .tab-btn.active { background: #2c3e50; color: white; }

        /* Dashboard Grid */
        .grid-dashboard { 
            display: grid; 
            /* Min 300px pour √©viter l'√©crasement sur mobile */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .car-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; position: relative; border-top: 5px solid transparent; }
        
        /* Status Colors */
        .status-dispo { border-top-color: #2ecc71; } .status-louee { border-top-color: #e74c3c; } .status-maintenance { border-top-color: #f39c12; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
        .bg-green { background: #2ecc71; } .bg-red { background: #e74c3c; } .bg-orange { background: #f39c12; } .bg-blue { background: #3498db; } .bg-gray { background: #95a5a6; } .bg-black { background: #333; }

        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .card-body { padding: 15px; }
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 10px; background: #f8f9fa; padding: 8px; border-radius: 8px; }
        .kpi-item { text-align: center; flex: 1; }
        .kpi-val { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .km-box { font-size: 0.85rem; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* --- CORRECTION CALENDRIER (FORCE DISPLAY) --- */
        .mini-cal-container { 
            margin-top: 10px; 
            /* Permet le scroll horizontal si vraiment trop petit, √©vite la coupe */
            overflow-x: auto; 
            overflow-y: hidden;
        }
        
        .fc { 
            font-size: 0.65rem !important; /* Police tr√®s compacte */
            min-width: 100%; /* Force la largeur minimale */
        }
        
        /* Force la table du calendrier √† prendre toute la place */
        .fc table { 
            width: 100% !important; 
            font-size: 0.65rem !important;
        }
        
        .fc-toolbar-title { font-size: 0.8rem !important; }
        .fc-button { padding: 2px 4px !important; font-size: 0.65rem !important; }
        .fc-daygrid-day-frame { min-height: 30px !important; } 
        
        /* R√©duit padding des jours (Lun/Mar) */
        .fc-col-header-cell-cushion { padding: 2px !important; font-weight: normal; } 
        .fc-event-title { font-size: 0.6rem !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .vidange-container { margin-top: 10px; padding: 8px; background: #f0f3f4; border-radius: 8px; font-size: 0.8rem; }
        .vidange-bar-bg { height: 6px; background: #ddd; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .vidange-bar-fill { height: 100%; transition: width 0.5s; }
        .vidange-text { display: flex; justify-content: space-between; color: #555; font-size: 0.7rem; }

        .card-actions { padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; gap: 5px; }
        .btn-action { flex: 1; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 600; text-align:center; }
        .btn-maint { background: #f39c12; color: white; } .btn-km { background: #34495e; color: white; } .btn-hist { background: #95a5a6; color: white; }

        /* Tableaux */
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; color: #333; font-size: 0.9rem; }
        tr:hover { background-color: #f9f9f9; }
        
        .btn-action-small { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem; margin-right: 5px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-publish { background: #2ecc71; } .btn-hide { background: #f39c12; } .btn-delete { background: #e74c3c; } .btn-edit { background: #3498db; } .btn-freeze { background: #9b59b6; }
        .row-frozen { background-color: #f2f2f2; color: #999; }
        .row-frozen td { color: #999; }

        .form-box { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-box input, .form-box select, .form-box textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .form-box label { font-weight: 600; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        .section-title-admin { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: #2c3e50; }

        .login-wrapper { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2c3e50; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 400px; text-align: center; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #777; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { border-bottom: 1px solid #eee; padding: 12px 5px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; gap: 15px; text-align: center; }
            .admin-tabs { flex-wrap: nowrap; overflow-x: auto; padding: 10px 0; gap: 5px; -webkit-overflow-scrolling: touch; }
            .tab-btn { flex: 0 0 auto; background: white; padding: 10px 15px; border: 1px solid #eee; }
            .grid-dashboard { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h2>Admin Rija Cars</h2>
            <p style="color:#777; font-size:0.9rem; margin-bottom:20px;">Acc√®s s√©curis√©</p>
            
            <input type="email" id="admin-email" placeholder="Email Administrateur" 
                   style="width:100%; padding:15px; margin-bottom:10px; font-size:1rem; border:1px solid #ccc; border-radius:5px;">
            
            <input type="password" id="admin-pass" placeholder="Mot de passe" 
                   style="width:100%; padding:15px; margin-bottom:20px; font-size:1rem; border:1px solid #ccc; border-radius:5px;">
            
            <button onclick="loginAdmin()" id="btn-login"
                    style="width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:5px; font-size:1.1rem; cursor:pointer;">
                Connexion
            </button>
            <p id="login-error" style="color:red; margin-top:15px; display:none; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="admin-header">
            <div>
                <h1 style="margin:0;">Administration</h1>
                <small>Gestion Rija Niaina Car Services</small>
            </div>
            
            <div class="user-profile-corner">
                <div class="user-name-display">
                    <span id="header-user-name">Chargement...</span><br>
                    <span id="header-user-role" class="user-role-badge">...</span>
                </div>
                <button onclick="ouvrirModalProfil()" title="Mon Profil" style="background:#ecf0f1; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; color:#2c3e50; font-size:1.1rem;">
                    <i class="fas fa-user-cog"></i>
                </button>
                <button onclick="logoutAdmin()" title="D√©connexion" style="background:#c0392b; color:white; border:none; border-radius:5px; padding:10px 15px; cursor:pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="admin-container">
            <div class="admin-tabs">
                <button id="btn-tab-dashboard" class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Tableau de Bord</button>
                <button id="btn-tab-reservations" class="tab-btn" onclick="switchTab('reservations')"><i class="fas fa-list-alt"></i> R√©servations</button>
                
                <button id="btn-tab-partenaires" class="tab-btn" onclick="switchTab('partenaires')"><i class="fas fa-users-cog"></i> Partenaires</button>
                
                <button id="btn-tab-maintenances" class="tab-btn" onclick="switchTab('maintenances')"><i class="fas fa-tools"></i> Maintenances</button>
                <button id="btn-tab-promos" class="tab-btn" onclick="switchTab('promos')"><i class="fas fa-tags"></i> Codes Promo</button>
                <button id="btn-tab-avis" class="tab-btn" onclick="switchTab('avis')"><i class="fas fa-star"></i> Avis Clients</button>
                <button id="btn-tab-pubs" class="tab-btn" onclick="switchTab('pubs')"><i class="fas fa-ad"></i> Publicit√©s</button>
                <button id="btn-tab-media" class="tab-btn" onclick="switchTab('media')"><i class="fas fa-music"></i> Divertissement</button>
            </div>

            <div id="view-dashboard">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button onclick="ouvrirModalVoiture()" class="btn-publish" style="padding:10px 15px;">
                        <i class="fas fa-plus-car"></i> Ajouter une Voiture
                    </button>
                    <div>
                        <span style="margin-right:10px; font-weight:bold;">P√©riode :</span>
                        <button class="btn-action-small active" style="background:#2c3e50;" onclick="setPeriode('mois')">Ce Mois</button>
                        <button class="btn-action-small" style="background:#95a5a6;" onclick="setPeriode('annee')">Cette Ann√©e</button>
                    </div>
                </div>
                <div id="grid-voitures" class="grid-dashboard"></div>
            </div>

            <div id="view-partenaires" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-user-plus"></i> Gestion / Cr√©ation Partenaire</h3>
                    <div class="form-grid">
                        <div><label>Nom</label><input type="text" id="part-nom" placeholder="Nom de famille"></div>
                        <div><label>Pr√©nom</label><input type="text" id="part-prenom" placeholder="Pr√©nom"></div>
                        <div><label>Email (Connexion)</label><input type="email" id="part-email" placeholder="email@exemple.com"></div>
                        <div><label>T√©l√©phone</label><input type="text" id="part-tel" placeholder="034..."></div>
                        <div><label>Dur√©e Contrat</label>
                            <select id="part-duree" onchange="calculerFinContrat()">
                                <option value="7">7 jours</option>
                                <option value="30">1 mois</option>
                                <option value="90">3 mois</option>
                                <option value="180">6 mois</option>
                                <option value="365">1 an</option>
                            </select>
                        </div>
                        <div><label>Fin Contrat (Calcul auto)</label><input type="date" id="part-fin" readonly style="background:#eee;"></div>
                        <div><label>Royalties (%)</label>
                            <select id="part-royalties">
                                <option value="5">5%</option>
                                <option value="7">7%</option>
                                <option value="10">10%</option>
                                <option value="15" selected>15% (Standard)</option>
                                <option value="20">20%</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:10px; background:#e8f8f5; padding:10px; border-left:4px solid #2ecc71; font-size:0.9rem;">
                        <strong><i class="fas fa-info-circle"></i> Proc√©dure :</strong> Remplissez ce formulaire pour d√©finir les infos du contrat. Si l'utilisateur n'existe pas encore dans la base d'authentification, vous devrez l'inviter via l'interface Supabase > Authentication.
                    </div>
                    <button onclick="upsertPartenaire()" class="btn-publish" style="width:100%; margin-top:10px; padding:10px;">Enregistrer Fiche Partenaire</button>
                </div>
                
                <div class="table-container">
                    <table id="table-partenaires">
                        <thead><tr><th>Partenaire</th><th>Contact</th><th>Contrat / Fin</th><th>Royalties</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-partenaires"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reservations" style="display:none;">
                <button onclick="toggleNewResaForm()" style="margin-bottom:15px; background:#2ecc71; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;"><i class="fas fa-plus-circle"></i> Nouvelle R√©servation (Comptoir)</button>
                <div id="form-new-resa" class="form-box" style="display:none; background:#e8f8f5;">
                    <h3 class="section-title-admin" style="margin-top:0;">Cr√©ation R√©servation Directe</h3>
                    <div class="form-grid">
                        <div><label>Voiture</label><select id="new-resa-voiture" onchange="calculerPrixAdmin()"></select></div>
                        <div><label>Client (Nom)</label><input type="text" id="new-resa-nom"></div>
                        <div><label>Client (Tel)</label><input type="text" id="new-resa-tel"></div>
                        <div><label>D√©but</label><input type="date" id="new-resa-debut" onchange="calculerPrixAdmin()"></div>
                        <div><label>Fin</label><input type="date" id="new-resa-fin" onchange="calculerPrixAdmin()"></div>
                        <div><label>Montant (Ar)</label><input type="number" id="new-resa-montant" onchange="updateResteAdmin()"></div>
                        <div><label>Statut</label><select id="new-resa-statut"><option value="valide">Valid√©</option><option value="en_attente">En attente</option></select></div>
                        <div><label>D√©j√† Pay√©</label><input type="number" id="new-resa-paye" value="0" onchange="updateResteAdmin()"></div>
                        <div><label>Reste</label><input type="number" id="new-resa-reste" readonly style="background:#ddd;"></div>
                    </div>
                    <button id="btn-creer-resa" onclick="creerReservationAdmin()" class="btn-publish" style="width:100%; margin-top:15px; padding:10px;">Cr√©er</button>
                </div>
                <div class="table-container">
                    <table id="table-resa-full">
                        <thead><tr><th>#ID</th><th>Client</th><th>Voiture</th><th>Paiement</th><th>Finances</th><th>OTP / Validation</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-resa-full"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-maintenances" style="display:none;">
                <div class="table-container">
                    <table id="table-maint-global">
                        <thead><tr><th>Date</th><th>Voiture</th><th>Type</th><th>D√©tails</th><th>Co√ªt</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-maint-global"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-promos" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-tag"></i> Ajouter un Code Promo</h3>
                    <div class="form-grid">
                        <div><label>Code (ex: ETE2024)</label><input type="text" id="promo-code" placeholder="Code en majuscule"></div>
                        <div><label>R√©duction (%)</label><input type="number" id="promo-pourcent" placeholder="Ex: 10"></div>
                        <div><label>Min. Jours</label><input type="number" id="promo-jours" placeholder="Ex: 3" value="1"></div>
                        <div><label>Date D√©but</label><input type="date" id="promo-debut"></div>
                        <div><label>Date Fin</label><input type="date" id="promo-fin"></div>
                    </div>
                    <button onclick="ajouterPromo()" class="btn-publish" style="width:100%; padding:12px; margin-top:10px;">Cr√©er Code</button>
                </div>
                <div class="table-container">
                    <table id="table-promos">
                        <thead><tr><th>Code</th><th>R√©duction</th><th>Conditions</th><th>Validit√©</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-promos"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-avis" style="display:none;">
                <div class="table-container">
                    <table id="table-avis">
                        <thead><tr><th>Date</th><th>Client</th><th>Note</th><th>Commentaire</th><th>Statut</th><th>Action</th></tr></thead>
                        <tbody id="tbody-avis"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-pubs" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-plus-circle"></i> Ajouter une Publicit√©</h3>
                    <div class="form-grid">
                        <div><label>Soci√©t√©</label><input type="text" id="pub-societe" placeholder="Nom de la soci√©t√©"></div>
                        <div><label>Contact</label><input type="text" id="pub-contact" placeholder="T√©l ou Email"></div>
                        <div><label>Emplacement</label><select id="pub-emplacement"><option value="home_top">Accueil Haut</option><option value="home_bot">Accueil Bas</option><option value="flotte_top">Liste Voitures Haut</option></select></div>
                        <div><label>Lien Image (URL)</label><input type="text" id="pub-image" placeholder="https://..."></div>
                        <div><label>Lien Redirection</label><input type="text" id="pub-lien" placeholder="Site web"></div>
                        <div><label>Date D√©but</label><input type="date" id="pub-debut" onchange="calculerFinPub()"></div>
                        <div><label>Dur√©e</label><select id="pub-duree" onchange="calculerFinPub()"><option value="7">7 jours</option><option value="15">15 jours</option><option value="30">1 mois</option><option value="90">3 mois</option><option value="365">1 an</option></select></div>
                        <div><label>Fin (Calcul√©e)</label><input type="date" id="pub-fin" readonly style="background:#eee;"></div>
                    </div>
                    <button onclick="ajouterPub()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Enregistrer Pub</button>
                </div>
                <div class="table-container">
                    <table id="table-pubs">
                        <thead><tr><th>Soci√©t√©</th><th>Emplacement</th><th>P√©riode</th><th>Image</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-pubs"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-media" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-broadcast-tower"></i> Ajouter une Radio</h3>
                    <div class="form-grid">
                        <div><label>Nom</label><input type="text" id="rad-nom" placeholder="Ex: RDJ"></div>
                        <div><label>Flux</label><input type="text" id="rad-url" placeholder="http://stream..."></div>
                        <div><label>Logo (URL)</label><input type="text" id="rad-logo" placeholder="https://image..."></div>
                    </div>
                    <button onclick="ajouterRadio()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Ajouter Radio</button>
                </div>
                <div class="table-container"><table id="table-radios"><thead><tr><th>Logo</th><th>Nom</th><th>Flux</th><th>Statut</th><th>Action</th></tr></thead><tbody id="tbody-radios"></tbody></table></div>
                
                <div class="form-box" style="margin-top:40px;">
                    <h3 class="section-title-admin"><i class="fas fa-music"></i> Gestion Playlist</h3>
                    <input type="hidden" id="play-id-edit">
                    <div class="form-grid">
                        <div><label>Titre</label><input type="text" id="play-titre" placeholder="Ex: Top Hits"></div>
                        <div><label>Plateforme</label><select id="play-plateforme"><option value="youtube">YouTube</option><option value="spotify">Spotify</option><option value="deezer">Deezer</option></select></div>
                        <div><label>Lien</label><input type="text" id="play-url" placeholder="URL (Playlist ou Vid√©o)"></div>
                    </div>
                    <button id="btn-save-playlist" onclick="ajouterPlaylist()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Ajouter Playlist</button>
                </div>
                <div class="table-container"><table id="table-playlists"><thead><tr><th>Plateforme</th><th>Titre</th><th>Lien</th><th>Statut</th><th>Action</th></tr></thead><tbody id="tbody-playlists"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="modal-profil" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <span class="close-modal" onclick="fermerModal('modal-profil')">√ó</span>
            <h3><i class="fas fa-key"></i> Modifier mot de passe</h3>
            <div style="margin-top:20px;">
                <label>Nouveau mot de passe</label>
                <input type="password" id="new-pass-1" placeholder="Nouveau..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
                <label>Confirmer nouveau</label>
                <input type="password" id="new-pass-2" placeholder="Confirmer..." style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:5px;">
                <button onclick="changerMotDePasse()" class="btn-publish" style="width:100%;">Valider changement</button>
            </div>
        </div>
    </div>

    <div id="modal-maint" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" onclick="fermerModal('modal-maint')">√ó</span>
            <h3>Maintenance</h3>
            <input type="hidden" id="maint-id-voiture">
            <label>Type principal</label>
            <select id="maint-type" onchange="updateSousCategories()" style="width:100%; margin-bottom:10px; padding:10px;">
                <option value="">-- S√©lectionner --</option>
                <option value="Vidange">Vidange</option>
                <option value="Pneus">Pneus</option>
                <option value="Freins">Freins</option>
                <option value="M√©canique">M√©canique</option>
                <option value="Carrosserie">Carrosserie</option>
                <option value="Autre">Autre</option>
            </select>
            <label id="lbl-sous-type" style="display:none;">Pr√©cisions (Sous-cat√©gorie)</label>
            <select id="maint-sous-type" style="display:none; width:100%; margin-bottom:10px; padding:10px; background:#f9f9f9;">
            </select>
            <label>Compteur (Km)</label>
            <input id="maint-km" type="number" placeholder="KM Compteur" style="width:100%; margin-bottom:10px; padding:10px;">
            <label>Notes / D√©tails</label>
            <textarea id="maint-details" placeholder="D√©tails suppl√©mentaires..." style="width:100%; margin-bottom:10px; padding:10px;"></textarea>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>D√©but</label><input type="date" id="maint-debut" style="width:100%; margin-bottom:10px;"></div>
                <div style="flex:1"><label>Fin (Estim√©e)</label><input type="date" id="maint-fin" style="width:100%; margin-bottom:10px;"></div>
            </div>
            <label>Co√ªt Total (Ar)</label>
            <input id="maint-cout" type="number" placeholder="Co√ªt" style="width:100%; padding:10px;">
            <button onclick="sauvegarderMaintenance()" class="btn-publish" style="width:100%; margin-top:10px;">Enregistrer Maintenance</button>
        </div>
    </div>

    <div id="modal-km" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-km')">√ó</span><h3>Kilom√©trage</h3><input type="hidden" id="km-id-voiture"><input type="number" id="km-valeur" style="width:100%; padding:10px;"><button onclick="sauvegarderKm()" class="btn-dark" style="width:100%; margin-top:10px;">OK</button></div></div>
    <div id="modal-historique" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-historique')">√ó</span><h3>Historique</h3><h4 id="hist-titre-voiture"></h4><ul id="historique-list" class="history-list"></ul><div style="text-align:right; font-weight:bold; margin-top:10px;">Total: <span id="hist-total"></span></div></div></div>
    <div id="modal-voiture" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-voiture')">√ó</span><h3>Ajout Voiture</h3><div class="form-grid"><div><input id="new-car-nom" placeholder="Nom"></div><div><select id="new-car-type"><option>Berline</option><option>SUV</option><option>4x4</option><option>Minibus</option></select></div><div><select id="new-car-trans"><option>Manuelle</option><option>Automatique</option></select></div><div><input id="new-car-prix" type="number" placeholder="Prix"></div><div><input id="new-car-img" placeholder="URL Image"></div><div><input id="new-car-ref" placeholder="Ref ID"></div></div><button onclick="ajouterVoiture()" class="btn-publish" style="width:100%; margin-top:10px;">Cr√©er</button></div></div>
    <div id="modal-edit-resa" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-edit-resa')">√ó</span><h3>Modifier Resa</h3><input type="hidden" id="edit-resa-id"><p id="edit-resa-client"></p><input type="date" id="edit-resa-debut"><input type="date" id="edit-resa-fin"><input type="number" id="edit-resa-montant"><select id="edit-resa-statut"><option value="valide">Valid√©</option><option value="en_attente">Attente</option><option value="annulee">Annul√©e</option></select><button onclick="sauvegarderModificationResa()" class="btn-publish" style="width:100%; margin-top:10px;">MAJ</button></div></div>

<script>
    const SUPABASE_URL = 'https://ctijwjcjmbfmfhzwbguk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let periodeAnalyse = 'mois';
    let globalVoitures = [];
    let currentUserRole = 'partenaire';

    const maintenanceTypes = {
        'Vidange': ['Moteur 5000km', 'Moteur 10000km', 'Bo√Æte de vitesse', 'Pont', 'Liquide refroidissement', 'Filtres complets'],
        'Pneus': ['Remplacement Avant Droite', 'Remplacement Avant Gauche', 'Remplacement Arri√®re Droite', 'Remplacement Arri√®re Gauche', 'Crevaison Avant', 'Crevaison Arri√®re', 'Casse Jante', 'Parall√©lisme', 'Equilibrage'],
        'Freins': ['Plaquettes Avant', 'Plaquettes Arri√®re', 'Disques Avant', 'Disques Arri√®re', 'Liquide de frein', 'M√¢choires'],
        'M√©canique': ['Amortisseurs', 'Batterie', 'Bougies', 'Courroie distribution', 'Embrayage', 'Alternateur', 'D√©marreur', 'Radiateur'],
        'Carrosserie': ['Rayure', 'Choc Avant', 'Choc Arri√®re', 'Retroviseur', 'Pare-brise', 'Peinture compl√®te'],
        'Autre': ['Climatisation', 'Lavage complet', 'Electricit√©', 'Divers', 'Contr√¥le Technique']
    };

    function genererCouleur(id) {
        const couleurs = ['#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#1abc9c', '#34495e', '#e67e22', '#16a085', '#8e44ad', '#2980b9'];
        if (!id) return couleurs[Math.floor(Math.random() * couleurs.length)];
        let hash = 0; for (let i = 0; i < id.toString().length; i++) { hash = id.toString().charCodeAt(i) + ((hash << 5) - hash); }
        return couleurs[Math.abs(hash) % couleurs.length];
    }

    // --- AUTH & INIT ---
    async function verifierSession() {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            const { data: profil } = await sb.from('profils').select('*').eq('id', session.user.id).single();
            if(profil) {
                currentUserRole = profil.role;
                document.getElementById('header-user-name').innerText = (profil.prenom || '') + ' ' + (profil.nom_complet || 'Utilisateur');
                document.getElementById('header-user-role').innerText = profil.role === 'admin' ? 'Super Admin' : 'Partenaire';
                afficherDashboard(currentUserRole);
            }
        } else { 
            document.getElementById('login-screen').style.display = 'flex'; 
            document.getElementById('admin-content').style.display = 'none'; 
        }
    }

    async function loginAdmin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-pass').value;
        const btn = document.getElementById('btn-login'); const err = document.getElementById('login-error');
        btn.innerText = "Chargement..."; btn.disabled = true; err.style.display = 'none';
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) { btn.innerText = "Connexion"; btn.disabled = false; err.innerText = error.message; err.style.display = 'block'; } else location.reload();
    }
    async function logoutAdmin() { await sb.auth.signOut(); location.reload(); }
    
    function afficherDashboard(role) {
        document.getElementById('login-screen').style.display = 'none'; document.getElementById('admin-content').style.display = 'block';
        if (role !== 'admin') {
            ['partenaires', 'promos', 'avis', 'pubs', 'media'].forEach(id => { const btn = document.getElementById('btn-tab-' + id); if(btn) btn.style.display = 'none'; });
        }
        toutRecharger();
    }

    // --- NAVIGATION ---
    function switchTab(tabName) {
        ['dashboard', 'reservations', 'maintenances', 'avis', 'pubs', 'media', 'promos', 'partenaires'].forEach(t => { const el = document.getElementById('view-'+t); if(el) el.style.display = 'none'; });
        document.getElementById('view-'+tabName).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active');
        if(tabName==='reservations') chargerVoituresPourSelect(); if(tabName==='maintenances') chargerTableMaintenances(); if(tabName==='promos') chargerTablePromos(); if(tabName==='partenaires') chargerTablePartenaires();
    }
    function toutRecharger() { chargerDashboard(); chargerTableReservations(); chargerTableMaintenances(); if(currentUserRole==='admin'){ chargerTableAvis(); chargerTablePubs(); chargerTableMedias(); chargerTablePromos(); chargerTablePartenaires(); } }
    function setPeriode(p) { periodeAnalyse = p; chargerDashboard(); }

    // --- GESTION PROFIL (MDP) ---
    function ouvrirModalProfil() { document.getElementById('modal-profil').style.display = 'flex'; }
    async function changerMotDePasse() {
        const p1 = document.getElementById('new-pass-1').value; const p2 = document.getElementById('new-pass-2').value;
        if(!p1 || p1.length < 6) return alert("Mot de passe trop court (6 min)");
        if(p1 !== p2) return alert("Les mots de passe ne correspondent pas");
        const { error } = await sb.auth.updateUser({ password: p1 });
        if(error) alert("Erreur: " + error.message); else { alert("Mot de passe modifi√© avec succ√®s !"); fermerModal('modal-profil'); }
    }

    // --- GESTION PARTENAIRES ---
    function calculerFinContrat() {
        const jours = parseInt(document.getElementById('part-duree').value);
        let d = new Date(); d.setDate(d.getDate() + jours);
        document.getElementById('part-fin').value = d.toISOString().split('T')[0];
    }

    async function upsertPartenaire() {
        const email = document.getElementById('part-email').value;
        const nom = document.getElementById('part-nom').value;
        const prenom = document.getElementById('part-prenom').value;
        const tel = document.getElementById('part-tel').value;
        const fin = document.getElementById('part-fin').value;
        const taux = document.getElementById('part-royalties').value;

        if(!email || !fin) return alert("Email et Dur√©e de contrat obligatoires");

        const { data: existing } = await sb.from('profils').select('id').eq('email', email).single();
        if (existing) {
            const { error } = await sb.from('profils').update({ nom_complet: nom, prenom: prenom, telephone: tel, date_fin_contrat: fin, commission_taux: taux }).eq('id', existing.id);
            if(error) alert("Erreur MAJ: " + error.message); else { alert("Contrat mis √† jour !"); chargerTablePartenaires(); }
        } else {
            alert("‚ö†Ô∏è UTILISATEUR INCONNU DANS SUPABASE AUTH\n\n1. Allez dans le panneau Supabase > Authentication > Users.\n2. Cliquez sur 'Invite User' et entrez : " + email + "\n3. Une fois l'utilisateur cr√©√©, revenez ici et validez ce formulaire pour mettre √† jour son contrat.");
        }
    }

    async function chargerTablePartenaires() {
        const tbody = document.getElementById('tbody-partenaires');
        const { data, error } = await sb.from('profils').select('*').order('created_at', {ascending:false});
        if(error) return console.error(error);
        
        tbody.innerHTML = '';
        if(data) data.forEach(p => {
            let isFreeze = p.est_gele;
            let isExpired = p.date_fin_contrat && new Date(p.date_fin_contrat) < new Date();
            let rowClass = isFreeze ? 'row-frozen' : '';
            let statut = '<span class="badge bg-green">ACTIF</span>';
            if(isFreeze) statut = '<span class="badge bg-black">GEL√â</span>';
            else if(isExpired) statut = '<span class="badge bg-red">EXPIR√â</span>';
            else if(p.role === 'admin') statut = '<span class="badge bg-blue">ADMIN</span>';

            let btnFreeze = '';
            if(p.role !== 'admin') {
                btnFreeze = isFreeze ? `<button class="btn-action-small btn-publish" onclick="toggleGel('${p.id}', false)">D√©geler</button>` : `<button class="btn-action-small btn-freeze" onclick="toggleGel('${p.id}', true)">Geler</button>`;
            }

            tbody.innerHTML += `<tr class="${rowClass}">
                <td><strong>${p.nom_complet || '-'}</strong> ${p.prenom || ''}<br><small>${p.email}</small></td>
                <td>${p.telephone || '-'}</td>
                <td>${p.date_fin_contrat ? new Date(p.date_fin_contrat).toLocaleDateString() : 'Illimit√©'}</td>
                <td><strong>${p.commission_taux || 15}%</strong></td>
                <td>${statut}</td>
                <td>${btnFreeze}</td>
            </tr>`;
        });
    }

    async function toggleGel(id, etat) {
        let action = etat ? "GELER" : "D√âGELER";
        if(confirm(`Voulez-vous vraiment ${action} ce compte ?\n\nSi gel√©, ses voitures dispara√Ætront imm√©diatement du site client.`)) {
            await sb.from('profils').update({ est_gele: etat }).eq('id', id);
            chargerTablePartenaires();
        }
    }

    // --- DASHBOARD (CARS) ---
    async function chargerDashboard() {
        const container = document.getElementById('grid-voitures');
        container.innerHTML = '<p>Chargement...</p>';
        const { data: voitures } = await sb.from('voitures').select('*, profils(est_gele, nom_complet)').order('id');
        const { data: resas } = await sb.from('reservations').select('*');
        const { data: maints } = await sb.from('maintenances').select('*');
        
        container.innerHTML = '';
        if(voitures) voitures.forEach(v => {
            let today = new Date().toISOString().split('T')[0];
            let statut='Dispo', badge='bg-green', border='status-dispo';
            let isMaint = maints ? maints.find(m => m.id_voiture === v.id && today >= m.date_debut && today <= m.date_fin) : false;
            let isLoc = resas ? resas.find(r => r.id_voiture === v.id && today >= r.date_debut && today <= r.date_fin && r.statut === 'valide') : false;
            let frozenInfo = (v.profils && v.profils.est_gele) ? `<div style="background:#333; color:white; padding:5px; text-align:center; font-size:0.8rem;"><i class="fas fa-lock"></i> COMPTE GEL√â</div>` : "";

            if(isMaint) { statut='Maintenance'; badge='bg-orange'; border='status-maintenance'; }
            else if(isLoc) { statut='Lou√©e'; badge='bg-red'; border='status-louee'; }

            let revenus = 0, joursLoues = 0;
            let now = new Date();
            let debutPeriode = (periodeAnalyse === 'mois') ? new Date(now.getFullYear(), now.getMonth(), 1) : new Date(now.getFullYear(), 0, 1);
            let resasPeriode = resas ? resas.filter(r => r.id_voiture === v.id && r.statut === 'valide' && new Date(r.date_debut) >= debutPeriode) : [];
            resasPeriode.forEach(r => { revenus += r.montant_total; let d1=new Date(r.date_debut), d2=new Date(r.date_fin); joursLoues += Math.ceil((d2-d1)/(86400000))+1; });
            let joursTotal = (periodeAnalyse === 'mois') ? 30 : 365; let taux = Math.round((joursLoues/joursTotal)*100);
            let kmActuel = v.kilometrage || 0; let kmDepuisVidange = kmActuel % 6000; let couleurJauge = kmDepuisVidange > 5000 ? '#e74c3c' : '#2ecc71';

            container.innerHTML += `
                <div class="car-card ${border}">
                    ${frozenInfo}
                    <div class="card-header"><div><strong>${v.nom}</strong><br><small style="color:#777">${v.profils?.nom_complet || 'Moi'}</small></div><div><span class="badge ${badge}">${statut}</span><button onclick="supprimerVoiture(${v.id})" style="background:none; border:none; color:#e74c3c; cursor:pointer; margin-left:5px;">‚úñ</button></div></div>
                    <div class="card-body">
                        <div class="km-box"><span>${kmActuel} km</span></div>
                        <div class="kpi-row"><div class="kpi-item"><div class="kpi-val">${(revenus/1000000).toFixed(1)}M</div></div><div class="kpi-item"><div class="kpi-val">${taux}%</div></div></div>
                        <div class="vidange-container"><div class="vidange-bar-bg"><div class="vidange-bar-fill" style="width: ${(kmDepuisVidange/60)}%; background:${couleurJauge}"></div></div><div class="vidange-text"><span>Fait: ${kmDepuisVidange}</span><span>Reste: ${6000-kmDepuisVidange}</span></div></div>
                        <div id="cal-${v.id}" class="mini-cal-container"></div>
                    </div>
                    <div class="card-actions"><button class="btn-action btn-maint" onclick="openMaint(${v.id})">Maint.</button><button class="btn-action btn-hist" onclick="voirHistorique(${v.id}, '${v.nom}')">Hist.</button><button class="btn-action btn-km" onclick="openKm(${v.id}, ${v.kilometrage||0})">Km</button></div>
                </div>`;
            setTimeout(() => initMiniCal(v.id, resas, maints), 200); 
        });
    }

    // --- FONCTIONS STANDARDS ---
    
    // NOUVELLE VERSION TIMELINE - AJUST√âE POUR LA TAILLE
    function initMiniCal(id, resas, maints) {
        let events = [];
        if(resas) resas.filter(r => r.id_voiture === id && r.statut === 'valide').forEach(r => { 
            let d = new Date(r.date_fin); d.setDate(d.getDate() + 1); 
            events.push({
                title: r.nom, 
                start: r.date_debut, 
                end: d.toISOString().split('T')[0], 
                color: genererCouleur(r.id),
                allDay: true
            });
        });

        if(maints) maints.filter(m => m.id_voiture === id).forEach(m => { 
            let d = new Date(m.date_fin); d.setDate(d.getDate() + 1); 
            events.push({
                title: 'üîß ' + m.type_intervention, 
                start: m.date_debut, 
                end: d.toISOString().split('T')[0], 
                color: '#c0392b'
            });
        });

        let el = document.getElementById('cal-' + id); 
        if(el) {
            el.innerHTML = "";
            new FullCalendar.Calendar(el, {
                initialView: 'dayGridMonth', 
                headerToolbar: { left: 'title', center: '', right: 'prev,next' },
                contentHeight: 'auto', 
                aspectRatio: 1.5,
                locale: 'fr', 
                events: events,
                eventDisplay: 'block', 
                displayEventTime: false,
                dayHeaderFormat: { weekday: 'short' } // Affiche "Lun" au lieu de "Lundi"
            }).render();
        }
    }
    
    function ouvrirModalVoiture() { document.getElementById('modal-voiture').style.display = 'flex'; }
    async function ajouterVoiture() {
        const { data: { user } } = await sb.auth.getUser();
        const voiture = { nom: document.getElementById('new-car-nom').value, type: document.getElementById('new-car-type').value, transmission: document.getElementById('new-car-trans').value, prix_base: document.getElementById('new-car-prix').value, image_url: document.getElementById('new-car-img').value, ref_id: document.getElementById('new-car-ref').value, kilometrage: 0, proprietaire_id: user.id };
        if(!voiture.nom) return alert("Nom requis"); await sb.from('voitures').insert([voiture]); fermerModal('modal-voiture'); chargerDashboard();
    }
    async function supprimerVoiture(id) { if(confirm("Supprimer ?")) await sb.from('voitures').delete().eq('id', id); chargerDashboard(); }
    
    async function chargerVoituresPourSelect() { const {data}=await sb.from('voitures').select('id,nom,prix_base'); globalVoitures=data||[]; const s=document.getElementById('new-resa-voiture'); s.innerHTML='<option>--</option>'; if(data) data.forEach(v=>s.innerHTML+=`<option value="${v.id}">${v.nom}</option>`); }
    function toggleNewResaForm() { const f=document.getElementById('form-new-resa'); f.style.display=(f.style.display==='none')?'block':'none'; }
    function calculerPrixAdmin() { const v=globalVoitures.find(x=>x.id==document.getElementById('new-resa-voiture').value); const d1=document.getElementById('new-resa-debut').value; const d2=document.getElementById('new-resa-fin').value; if(v&&d1&&d2) document.getElementById('new-resa-montant').value = v.prix_base * (Math.ceil(Math.abs(new Date(d2)-new Date(d1))/86400000)+1); updateResteAdmin(); }
    function updateResteAdmin() { document.getElementById('new-resa-reste').value = (document.getElementById('new-resa-montant').value||0) - (document.getElementById('new-resa-paye').value||0); }
    
    // VERSION S√âCURIS√âE (Double-click fix + Date lock)
    async function creerReservationAdmin() { 
        const btn = document.getElementById('btn-creer-resa');
        btn.disabled = true;
        btn.innerText = "V√©rification...";

        try {
            const voitureId = document.getElementById('new-resa-voiture').value;
            const debut = document.getElementById('new-resa-debut').value;
            const fin = document.getElementById('new-resa-fin').value;

            // V√âRIFICATION COLLISION
            const { data: conflits } = await sb.from('reservations')
                .select('id')
                .eq('id_voiture', voitureId)
                .eq('statut', 'valide')
                .or(`and(date_debut.lte.${fin},date_fin.gte.${debut})`);
                
            if (conflits && conflits.length > 0) {
                alert("‚õî IMPOSSIBLE : Cette voiture est d√©j√† r√©serv√©e sur cette p√©riode !");
                return;
            }

            const r={id_voiture:voitureId, nom:document.getElementById('new-resa-nom').value, tel:document.getElementById('new-resa-tel').value, date_debut:debut, date_fin:fin, montant_total:document.getElementById('new-resa-montant').value, statut:document.getElementById('new-resa-statut').value, paiement_montant_declare:document.getElementById('new-resa-paye').value}; 
            if(r.statut==='valide') r.code_otp='MANUEL';
            
            await sb.from('reservations').insert([r]); 
            alert('R√©servation cr√©√©e !'); 
            toggleNewResaForm(); 
            toutRecharger();
            
        } catch (error) {
            console.error(error);
            alert("Erreur lors de la cr√©ation");
        } finally {
            btn.disabled = false;
            btn.innerText = "Cr√©er";
        }
    }
    
    async function chargerTableReservations() { 
        const tbody = document.getElementById('tbody-resa-full');
        const { data } = await sb.from('reservations').select('*, voitures(nom)').order('id', {ascending:false});
        
        tbody.innerHTML = '';
        if(data) data.forEach(r => {
            let actions = '';
            let otpDisplay = '';

            if (r.statut === 'valide') {
                otpDisplay = `<strong style="color:green; font-size:1.1rem;">${r.code_otp || '-'}</strong>`;
                actions = `<button class="btn-action-small" style="background:#ccc; cursor:not-allowed;">D√©j√† Valid√©</button>`;
            } 
            else {
                otpDisplay = `<input type="text" id="otp-${r.id}" placeholder="Code" style="width:70px; padding:5px; text-align:center;">`;
                actions = `<button class="btn-action-small btn-publish" onclick="validerResa(${r.id})"><i class="fas fa-check"></i> Valider</button>`;
            }

            actions += `
                <button class="btn-action-small" style="background:#8e44ad;" onclick="genererPDFAdmin(${r.id})" title="T√©l√©charger PDF"><i class="fas fa-file-pdf"></i></button>
                <button class="btn-action-small btn-edit" onclick="ouvrirModifResa(${r.id})"><i class="fas fa-edit"></i></button>
                <button class="btn-action-small btn-delete" onclick="annulerResa(${r.id})"><i class="fas fa-trash"></i></button>
            `;

            let mode = r.paiement_methode === 'mvola' ? '<span class="badge bg-blue">Mvola</span>' : '<span class="badge bg-green">Esp√®ces</span>';
            let detailPayeur = `<strong>${r.paiement_titulaire || 'Non pr√©cis√©'}</strong>`;
            
            tbody.innerHTML += `
            <tr>
                <td><strong>#${r.id}</strong><br>${r.statut === 'valide' ? '<span style="color:green;">‚óè Valid√©</span>' : '<span style="color:orange;">‚óè Attente</span>'}</td>
                <td><strong>${r.nom}</strong><br><small>${r.tel}</small></td>
                <td><strong>${r.voitures?.nom || 'Inconnue'}</strong><br>${r.date_debut} / ${r.date_fin}</td>
                <td>${mode}<br>${detailPayeur}</td>
                <td>Total: <strong>${r.montant_total}</strong><br>Pay√©: ${r.paiement_montant_declare || 0}</td>
                <td>${otpDisplay}</td>
                <td><div style="display:flex; gap:5px; flex-wrap:wrap;">${actions}</div></td>
            </tr>`;
        });
    }

    async function validerResa(id) { 
        const code = document.getElementById('otp-'+id).value;
        if(!code) return alert("Code OTP manquant");
        await sb.from('reservations').update({statut:'valide', code_otp:code}).eq('id',id); toutRecharger(); 
    }
    async function annulerResa(id) { if(confirm('‚ö†Ô∏è Supprimer d√©finitivement cette r√©servation ?')) { await sb.from('reservations').delete().eq('id',id); toutRecharger(); } }

    async function chargerTableMaintenances() { const {data}=await sb.from('maintenances').select('*,voitures(nom)').order('date_debut',{ascending:false}); document.getElementById('tbody-maint-global').innerHTML=data.map(m=>`<tr><td>${m.date_debut}</td><td>${m.voitures?.nom}</td><td>${m.type_intervention}</td><td>${m.details}</td><td>${m.cout}</td><td><button class="btn-action-small btn-delete" onclick="supprimerMaintenance(${m.id})">X</button></td></tr>`).join(''); }
    async function supprimerMaintenance(id) { if(confirm('Sur?')) await sb.from('maintenances').delete().eq('id',id); chargerTableMaintenances(); chargerDashboard(); }

    // --- PROMOS, PUBS, MEDIA ---
    async function chargerTablePromos() {
        const { data } = await sb.from('codes_promo').select('*').order('created_at', {ascending:false});
        document.getElementById('tbody-promos').innerHTML = data ? data.map(p => `<tr><td>${p.code}</td><td>${p.reduction_pourcent}%</td><td>${p.min_jours}j</td><td>${p.actif?'Active':'Off'}</td><td><button onclick="togglePromo(${p.id}, ${!p.actif})" class="btn-action-small ${p.actif?'btn-hide':'btn-publish'}">Toggle</button><button onclick="supprimerPromo(${p.id})" class="btn-action-small btn-delete">X</button></td></tr>`).join('') : '';
    }
    async function ajouterPromo() { await sb.from('codes_promo').insert([{code:document.getElementById('promo-code').value.toUpperCase(), reduction_pourcent:document.getElementById('promo-pourcent').value, min_jours:document.getElementById('promo-jours').value, date_debut:document.getElementById('promo-debut').value, date_fin:document.getElementById('promo-fin').value, actif:true}]); chargerTablePromos(); }
    async function togglePromo(id, s) { await sb.from('codes_promo').update({actif:s}).eq('id',id); chargerTablePromos(); }
    async function supprimerPromo(id) { if(confirm('Sur?')) await sb.from('codes_promo').delete().eq('id',id); chargerTablePromos(); }

    async function chargerTablePubs() { const {data}=await sb.from('publicites').select('*'); document.getElementById('tbody-pubs').innerHTML=data?data.map(p=>`<tr><td>${p.societe}</td><td>${p.emplacement}</td><td>${p.date_fin}</td><td>${p.actif?'On':'Off'}</td><td><button onclick="delPub(${p.id})" class="btn-action-small btn-delete">X</button></td></tr>`).join(''):''; }
    async function ajouterPub() { await sb.from('publicites').insert([{societe:document.getElementById('pub-societe').value, contact:document.getElementById('pub-contact').value, emplacement:document.getElementById('pub-emplacement').value, image_url:document.getElementById('pub-image').value, lien_redirection:document.getElementById('pub-lien').value, date_debut:document.getElementById('pub-debut').value, date_fin:document.getElementById('pub-fin').value, actif:true}]); chargerTablePubs(); }
    function calculerFinPub() { let d=new Date(document.getElementById('pub-debut').value); d.setDate(d.getDate()+parseInt(document.getElementById('pub-duree').value)); document.getElementById('pub-fin').value=d.toISOString().split('T')[0]; }
    async function delPub(id) { if(confirm('Sur?')) await sb.from('publicites').delete().eq('id',id); chargerTablePubs(); }

    async function chargerTableMedias() {
        const {data:r}=await sb.from('radios').select('*'); document.getElementById('tbody-radios').innerHTML=r?r.map(x=>`<tr><td><img src="${x.image_url}" width="30"></td><td>${x.nom}</td><td>${x.url_flux}</td><td>${x.actif?'On':'Off'}</td><td><button onclick="delMedia('radios',${x.id})" class="btn-delete">X</button></td></tr>`).join(''):'';
        const {data:p}=await sb.from('playlists').select('*'); document.getElementById('tbody-playlists').innerHTML=p?p.map(x=>`<tr><td>${x.plateforme}</td><td>${x.titre}</td><td>Embed</td><td>${x.actif?'On':'Off'}</td><td><button onclick="delMedia('playlists',${x.id})" class="btn-delete">X</button></td></tr>`).join(''):'';
    }
    async function ajouterRadio() { await sb.from('radios').insert([{nom:document.getElementById('rad-nom').value, url_flux:document.getElementById('rad-url').value, image_url:document.getElementById('rad-logo').value, actif:true}]); chargerTableMedias(); }
    async function ajouterPlaylist() { await sb.from('playlists').insert([{titre:document.getElementById('play-titre').value, plateforme:document.getElementById('play-plateforme').value, url_embed:document.getElementById('play-url').value, actif:true}]); chargerTableMedias(); }
    async function delMedia(t,id) { if(confirm('Sur?')) await sb.from(t).delete().eq('id',id); chargerTableMedias(); }

    async function chargerTableAvis() { const {data}=await sb.from('avis').select('*'); document.getElementById('tbody-avis').innerHTML=data?data.map(a=>`<tr><td>${a.nom}</td><td>${a.note}/5</td><td>${a.commentaire}</td><td>${a.visible?'Publi√©':'Masqu√©'}</td><td><button onclick="toggleAvis(${a.id},${!a.visible})" class="btn-publish">Toggle</button></td></tr>`).join(''):''; }
    async function toggleAvis(id,v) { await sb.from('avis').update({visible:v}).eq('id',id); chargerTableAvis(); }

    // Helpers UI & Modales Compl√©mentaires
    function fermerModal(id) { document.getElementById(id).style.display='none'; }
    function openMaint(id) { document.getElementById('maint-id-voiture').value=id; document.getElementById('modal-maint').style.display='flex'; }
    function openKm(id,k) { document.getElementById('km-id-voiture').value=id; document.getElementById('km-valeur').value=k; document.getElementById('modal-km').style.display='flex'; }
    async function voirHistorique(id,n) { document.getElementById('hist-titre-voiture').innerText=n; document.getElementById('modal-historique').style.display='flex'; const {data}=await sb.from('maintenances').select('*').eq('id_voiture',id); document.getElementById('historique-list').innerHTML=data.map(m=>`<li class="history-item"><span>${m.date_debut} : ${m.type_intervention}</span><span>${m.cout}Ar</span></li>`).join(''); }
    async function sauvegarderKm() { await sb.from('voitures').update({kilometrage:document.getElementById('km-valeur').value}).eq('id',document.getElementById('km-id-voiture').value); fermerModal('modal-km'); chargerDashboard(); }
    
    function updateSousCategories() {
        const type = document.getElementById('maint-type').value;
        const sousSelect = document.getElementById('maint-sous-type');
        const lblSous = document.getElementById('lbl-sous-type');
        
        sousSelect.innerHTML = '';
        
        if(maintenanceTypes[type]) {
            lblSous.style.display = 'block';
            sousSelect.style.display = 'block';
            maintenanceTypes[type].forEach(st => {
                const opt = document.createElement('option');
                opt.value = st;
                opt.innerText = st;
                sousSelect.appendChild(opt);
            });
        } else {
            lblSous.style.display = 'none';
            sousSelect.style.display = 'none';
        }
    }

    async function sauvegarderMaintenance() {
        const type = document.getElementById('maint-type').value;
        const sousType = document.getElementById('maint-sous-type').value;
        const details = document.getElementById('maint-details').value;
        
        let finalType = type;
        if (sousType && document.getElementById('maint-sous-type').style.display !== 'none') {
            finalType += ` (${sousType})`;
        }

        await sb.from('maintenances').insert([{
            id_voiture: document.getElementById('maint-id-voiture').value, 
            type_intervention: finalType, 
            cout: document.getElementById('maint-cout').value, 
            date_debut: document.getElementById('maint-debut').value, 
            date_fin: document.getElementById('maint-fin').value, 
            details: details
        }]); 
        
        fermerModal('modal-maint'); chargerDashboard(); 
    }

    // NOUVELLE FONCTION PDF (HEADER BLEU IDENTIQUE CLIENT)
    async function genererPDFAdmin(idResa) {
        const { data: r, error } = await sb.from('reservations').select('*, voitures(nom, ref_id)').eq('id', idResa).single();
        if (error || !r) return alert("Erreur donn√©es PDF");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // --- D√âBUT EN-T√äTE IDENTIQUE CLIENT ---
        // Fond bleu fonc√©
        doc.setFillColor(44, 62, 80); 
        doc.rect(0, 0, 210, 40, 'F');
        
        // Titre
        doc.setTextColor(255, 255, 255); 
        doc.setFontSize(22); 
        doc.text("RIJA NIAINA CAR SERVICES", 105, 15, { align: "center" });
        
        // Adresse et T√©l (Au lieu de "ADMINISTRATION - DUPLICATA")
        doc.setFontSize(10); 
        doc.text("Siae 33 Ambodifilao, Analakely, Antananarivo 101", 105, 25, { align: "center" });
        doc.text("Tel: +261 38 85 524 32", 105, 32, { align: "center" });
        // --- FIN EN-T√äTE IDENTIQUE CLIENT ---

        // Infos Document
        doc.setTextColor(0, 0, 0); doc.setFontSize(11);
        doc.text(`Date : ${new Date().toLocaleDateString('fr-FR')}`, 195, 50, { align: "right" });
        doc.setFontSize(14); doc.setFont("helvetica", "bold");
        doc.text(`FACTURE / RE√áU N¬∞ ${r.id}`, 14, 60);

        // Calculs dur√©es
        const d1 = new Date(r.date_debut); const d2 = new Date(r.date_fin);
        const duree = Math.ceil(Math.abs(d2 - d1) / (86400000)) + 1;

        // Construction des donn√©es du tableau
        const clientInfo = `CLIENT\nNom : ${r.nom} ${r.prenom || ''}\nT√©l : ${r.tel}\nCIN : ${r.cin_passeport || 'Non renseign√©'}`;
        const voitureInfo = `V√âHICULE\nMod√®le : ${r.voitures?.nom}\nRef : ${r.voitures?.ref_id || 'N/A'}\n\nDATES\nDu : ${r.date_debut}\nAu : ${r.date_fin}\n(${duree} jours)`;
        
        // Calcul du reste √† payer pour l'affichage
        const total = r.montant_total || 0;
        const paye = r.paiement_montant_declare || 0;
        const reste = total - paye;
        
        const paiementInfo = `FINANCIER\nTotal : ${total.toLocaleString('fr-FR')} Ar\nD√©j√† pay√© : ${paye.toLocaleString('fr-FR')} Ar\nReste : ${reste.toLocaleString('fr-FR')} Ar\nMode : ${r.paiement_methode || '-'}`;

        // G√©n√©ration du tableau (Identique au style client : Bleu)
        doc.autoTable({
            startY: 70,
            head: [['LOCATAIRE', 'D√âTAILS LOCATION', 'R√àGLEMENT']],
            body: [[clientInfo, voitureInfo, paiementInfo]],
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], halign: 'center' }, // Bleu clair comme sur le site client
            styles: { fontSize: 10, cellPadding: 5, valign: 'top' },
            columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 70 }, 2: { cellWidth: 60 } }
        });

        // Pied de page (Statut)
        doc.setFontSize(10);
        if(r.statut === 'valide') {
            doc.setTextColor(39, 174, 96); // Vert
            doc.text(`STATUS : PAY√â & VALID√â (OTP: ${r.code_otp || 'Manuel'})`, 14, doc.lastAutoTable.finalY + 15);
        } else {
            doc.setTextColor(231, 76, 60); // Rouge
            doc.text(`STATUS : EN ATTENTE / NON PAY√â`, 14, doc.lastAutoTable.finalY + 15);
        }

        doc.save(`Facture_Admin_${r.id}.pdf`);
    }

    async function ouvrirModifResa(id) {
        const { data: resa } = await sb.from('reservations').select('*').eq('id', id).single();
        if(resa) {
            document.getElementById('edit-resa-id').value = resa.id;
            document.getElementById('edit-resa-client').innerText = `${resa.nom} (${resa.tel})`;
            document.getElementById('edit-resa-debut').value = resa.date_debut;
            document.getElementById('edit-resa-fin').value = resa.date_fin;
            document.getElementById('edit-resa-montant').value = resa.montant_total;
            document.getElementById('edit-resa-statut').value = resa.statut;
            document.getElementById('modal-edit-resa').style.display = 'flex';
        }
    }
    async function sauvegarderModificationResa() {
        const id = document.getElementById('edit-resa-id').value;
        const debut = document.getElementById('edit-resa-debut').value;
        const fin = document.getElementById('edit-resa-fin').value;
        const montant = document.getElementById('edit-resa-montant').value;
        const statut = document.getElementById('edit-resa-statut').value;
        await sb.from('reservations').update({ date_debut: debut, date_fin: fin, montant_total: montant, statut: statut }).eq('id', id);
        fermerModal('modal-edit-resa'); toutRecharger();
    }

    verifierSession();
</script>
</body>
</html>