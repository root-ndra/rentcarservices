<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rent Cars Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- STYLES ADMIN --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        .admin-header { background: white; padding: 15px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .user-profile-corner { display: flex; align-items: center; gap: 15px; }
        .user-name-display { font-weight: bold; color: #2c3e50; text-align: right; line-height: 1.2; }
        .user-role-badge { font-size: 0.75rem; color: #7f8c8d; font-weight: normal; }
        
        .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn { padding: 12px 20px; background: transparent; border: none; font-size: 0.95rem; font-weight: 600; color: #555; cursor: pointer; border-radius: 6px; transition: 0.3s; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .tab-btn:hover { background: #f0f0f0; color: #2c3e50; }
        .tab-btn.active { background: #2c3e50; color: white; }

        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .car-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border-top: 5px solid transparent; }
        
        .status-dispo { border-top-color: #2ecc71; } .status-louee { border-top-color: #e74c3c; } .status-maintenance { border-top-color: #f39c12; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
        .bg-green { background: #2ecc71; } .bg-red { background: #e74c3c; } .bg-orange { background: #f39c12; } .bg-blue { background: #3498db; }
        
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .card-body { padding: 15px; }
        .card-actions { padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; gap: 5px; }
        .btn-action { flex: 1; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 600; text-align:center; }
        .btn-maint { background: #f39c12; color: white; } .btn-km { background: #34495e; color: white; }
        
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f9f9f9; }

        .form-box { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .login-wrapper { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2c3e50; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 400px; text-align: center; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; }

        /* Helpers Visibilité selon rôle */
        .only-super-admin { display: none !important; }
        .show-super-admin .only-super-admin { display: block !important; }
        .show-super-admin .only-super-admin-flex { display: flex !important; }
        .show-super-admin .only-super-admin-inline { display: inline-block !important; }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h2>Admin Rija Cars</h2>
            <p>Accès Partenaire & Super Admin</p>
            <input type="email" id="admin-email" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="admin-pass" placeholder="Mot de passe" style="margin-bottom:20px;">
            <button onclick="loginAdmin()" style="width:100%; padding:15px; background:#3498db; color:white; border:none; cursor:pointer;">Connexion</button>
            <p id="login-error" style="color:red; display:none;"></p>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="admin-header">
            <div>
                <h1 style="margin:0;">Administration</h1>
                <small id="role-display-text">Chargement...</small>
            </div>
            <div class="user-profile-corner">
                <div class="user-name-display">
                    <span id="header-user-name">...</span><br>
                    <span id="header-user-role" class="user-role-badge">...</span>
                </div>
                <button onclick="logoutAdmin()" title="Déconnexion" style="background:#c0392b; color:white; border:none; padding:10px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="admin-container">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-car"></i> Mes Voitures</button>
                <button class="tab-btn" onclick="switchTab('reservations')"><i class="fas fa-list-alt"></i> Réservations</button>
                <button class="tab-btn" onclick="switchTab('maintenances')"><i class="fas fa-tools"></i> Maintenances</button>
                
                <button class="tab-btn only-super-admin" onclick="switchTab('partenaires')"><i class="fas fa-users-cog"></i> Utilisateurs (Admin)</button>
                <button class="tab-btn only-super-admin" onclick="switchTab('config')"><i class="fas fa-cogs"></i> Config Site</button>
                <button class="tab-btn only-super-admin" onclick="switchTab('promos')"><i class="fas fa-tags"></i> Codes Promo</button>
            </div>

            <div id="view-dashboard">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <button onclick="ouvrirModalVoiture()" style="background:#2ecc71; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer;">
                        <i class="fas fa-plus-circle"></i> Ajouter une Voiture
                    </button>
                </div>
                <div id="grid-voitures" class="grid-dashboard"></div>
            </div>

            <div id="view-reservations" style="display:none;">
                <h3 class="section-title-admin">Suivi des Réservations</h3>
                <div class="table-container">
                    <table id="table-resa-full">
                        <thead><tr><th>#</th><th>Client</th><th>Voiture</th><th>Dates</th><th>Montant</th><th>Statut</th></tr></thead>
                        <tbody id="tbody-resa-full"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-maintenances" style="display:none;">
                <h3>Maintenances & Entretiens</h3>
                 <div class="table-container">
                    <table id="table-maint">
                        <thead><tr><th>Voiture</th><th>Type</th><th>Dates</th><th>Coût</th><th>Action</th></tr></thead>
                        <tbody id="tbody-maint"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-partenaires" style="display:none;">
                <h3>Gestion des Utilisateurs & Rôles</h3>
                <p>En tant que Super Admin, vous pouvez promouvoir d'autres utilisateurs.</p>
                <div class="table-container">
                    <table id="table-partenaires">
                        <thead><tr><th>Email</th><th>Nom</th><th>Rôle Actuel</th><th>Action</th></tr></thead>
                        <tbody id="tbody-partenaires"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-config" style="display:none;"><h3>Configuration Générale</h3><p>Options globales du site.</p></div>
            <div id="view-promos" style="display:none;"><h3>Codes Promo</h3></div>

        </div>
    </div>

    <div id="modal-voiture" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="fermerModal('modal-voiture')">×</span>
            <h3>Ajouter / Modifier Voiture</h3>
            <div class="form-grid">
                <div><label>Nom</label><input id="car-nom"></div>
                <div><label>Prix (Ar/j)</label><input id="car-prix" type="number"></div>
                <div><label>Ref ID</label><input id="car-ref"></div>
                <div><label>Image URL</label><input id="car-img"></div>
                <div><label>Description</label><textarea id="car-desc"></textarea></div>
                <div>
                    <label>Réservable en ligne ?</label>
                    <select id="car-reservable">
                        <option value="true">Oui</option>
                        <option value="false">Non (Contact Seul)</option>
                    </select>
                </div>
            </div>
            <button onclick="sauvegarderVoiture()" style="width:100%; margin-top:10px; padding:10px; background:#3498db; color:white; border:none;">Enregistrer</button>
        </div>
    </div>

    <script src="script.js"></script>

    <script>
        // --- LOGIQUE ADMIN SPÉCIFIQUE ---
        let currentUser = null;
        let currentRole = 'partenaire'; // par défaut

        // 1. LOGIN ADMIN
        async function loginAdmin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-pass').value;
            
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) {
                document.getElementById('login-error').innerText = error.message;
                document.getElementById('login-error').style.display = 'block';
            } else {
                checkSessionAdmin();
            }
        }

        async function logoutAdmin() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // 2. VERIFICATION SESSION & ROLE
        async function checkSessionAdmin() {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                currentUser = session.user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('header-user-name').innerText = currentUser.email;

                // Récupérer le Rôle depuis la table 'partenaires'
                // NOTE: Si l'utilisateur n'existe pas dans la table partenaires, on le crée à la volée
                let { data: part } = await sb.from('partenaires').select('*').eq('user_id', currentUser.id).single();
                
                if (!part) {
                    // Création auto du profil partenaire
                    const { data: newPart, error } = await sb.from('partenaires').insert([
                        { user_id: currentUser.id, email: currentUser.email, role: 'partenaire' }
                    ]).select().single();
                    part = newPart;
                }

                currentRole = part ? part.role : 'partenaire';
                
                // --- APPLIQUER LA VISIBILITÉ ---
                document.getElementById('header-user-role').innerText = currentRole.toUpperCase();
                document.getElementById('role-display-text').innerText = (currentRole === 'super_admin') 
                    ? "Mode: SUPER ADMIN (Accès Total)" 
                    : "Mode: PARTENAIRE (Accès Limité)";

                const body = document.body;
                if (currentRole === 'super_admin') {
                    document.getElementById('admin-content').classList.add('show-super-admin');
                } else {
                    document.getElementById('admin-content').classList.remove('show-super-admin');
                }

                chargerDashboard();
            }
        }

        // 3. DASHBOARD (Voitures)
        async function chargerDashboard() {
            const grid = document.getElementById('grid-voitures');
            grid.innerHTML = '<p>Chargement...</p>';
            
            // RLS filtre automatiquement : Admin voit tout, Partenaire voit les siennes
            const { data: voitures } = await sb.from('voitures').select('*').order('created_at', { ascending: false });
            
            grid.innerHTML = '';
            if (voitures && voitures.length > 0) {
                voitures.forEach(v => {
                    grid.innerHTML += `
                    <div class="car-card status-dispo">
                        <div class="card-header">
                            <strong>${v.nom}</strong>
                            <span class="badge bg-green">Visible</span>
                        </div>
                        <div class="card-body">
                            <small>Ref: ${v.ref_id}</small><br>
                            <small>Prix: ${v.prix_base} Ar</small>
                        </div>
                        <div class="card-actions">
                            <button class="btn-action btn-maint" onclick="alert('Maintenance à venir')"><i class="fas fa-tools"></i></button>
                            <button class="btn-action" style="background:#e74c3c; color:white;" onclick="supprimerVoiture('${v.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            } else {
                grid.innerHTML = '<p>Aucune voiture affichée.</p>';
            }
        }

        // 4. RESERVATIONS
        async function chargerReservations() {
            const tbody = document.getElementById('tbody-resa-full');
            tbody.innerHTML = '<tr><td colspan="6">Chargement...</td></tr>';

            // RLS fait le travail de filtre
            const { data: resas } = await sb.from('reservations').select('*, voitures(nom)').order('created_at', { ascending: false });

            tbody.innerHTML = '';
            if(resas) {
                resas.forEach(r => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.nom} (${r.tel})</td>
                        <td>${r.voitures ? r.voitures.nom : 'Inconnu'}</td>
                        <td>${r.date_debut} au ${r.date_fin}</td>
                        <td>${r.montant_total} Ar</td>
                        <td>${r.statut}</td>
                    </tr>`;
                });
            }
        }

        // 5. GESTION UTILISATEURS (Super Admin)
        async function chargerPartenaires() {
            if(currentRole !== 'super_admin') return; // Sécurité UI
            
            const tbody = document.getElementById('tbody-partenaires');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            
            const { data: parts } = await sb.from('partenaires').select('*');
            
            tbody.innerHTML = '';
            if(parts) {
                parts.forEach(p => {
                    const isMe = (p.user_id === currentUser.id);
                    const btnPromote = (p.role === 'partenaire') 
                        ? `<button onclick="changerRole('${p.user_id}', 'super_admin')" style="background:#2ecc71; color:white; border:none; padding:5px;">Promouvoir Admin</button>` 
                        : `<button onclick="changerRole('${p.user_id}', 'partenaire')" style="background:#e74c3c; color:white; border:none; padding:5px;">Rétrograder</button>`;
                    
                    tbody.innerHTML += `
                    <tr>
                        <td>${p.email}</td>
                        <td>${p.nom || '-'}</td>
                        <td><strong>${p.role.toUpperCase()}</strong></td>
                        <td>${isMe ? 'Vous' : btnPromote}</td>
                    </tr>`;
                });
            }
        }

        async function changerRole(targetId, newRole) {
            if(!confirm("Êtes-vous sûr de changer le rôle de cet utilisateur ?")) return;
            const { error } = await sb.from('partenaires').update({ role: newRole }).eq('user_id', targetId);
            if(error) alert("Erreur: " + error.message);
            else chargerPartenaires();
        }

        // 6. AJOUTER VOITURE (Auto-assignation Propriétaire)
        async function sauvegarderVoiture() {
            const nom = document.getElementById('car-nom').value;
            const prix = document.getElementById('car-prix').value;
            const ref = document.getElementById('car-ref').value;
            const img = document.getElementById('car-img').value;
            const desc = document.getElementById('car-desc').value;
            const reservable = document.getElementById('car-reservable').value === 'true';

            if(!nom || !prix) return alert("Champs obligatoires manquants");

            const newCar = {
                nom, prix_base: parseInt(prix), ref_id: ref, image_url: img, description: desc,
                reservable: reservable,
                proprietaire_id: currentUser.id // IMPORTANT : Lie la voiture à l'utilisateur connecté
            };

            const { error } = await sb.from('voitures').insert([newCar]);
            if(error) alert("Erreur : " + error.message);
            else {
                alert("Voiture ajoutée !");
                fermerModal('modal-voiture');
                chargerDashboard();
            }
        }

        async function supprimerVoiture(id) {
            if(confirm("Supprimer cette voiture ?")) {
                const { error } = await sb.from('voitures').delete().eq('id', id);
                if(error) alert("Erreur: " + error.message);
                else chargerDashboard();
            }
        }

        // TABS
        function switchTab(tab) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.style.display = 'none');
            document.getElementById('view-'+tab).style.display = 'block';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(tab === 'reservations') chargerReservations();
            if(tab === 'partenaires') chargerPartenaires();
        }

        function ouvrirModalVoiture() { document.getElementById('modal-voiture').style.display = 'flex'; }
        function fermerModal(id) { document.getElementById(id).style.display = 'none'; }

        // Init
        checkSessionAdmin();
    </script>
</body>
</html>
