<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rija Cars</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Styles Admin Spécifiques (Conserver les styles existants + Ajouts) */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .table-container { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #2c3e50; color: white; }
        .btn-action-small { padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; color: white; margin: 2px; }
        .form-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    </style>
</head>
<body>

    <div id="login-screen" style="height:100vh; display:flex; justify-content:center; align-items:center; background:#2c3e50;">
        <div style="background:white; padding:30px; border-radius:10px; text-align:center;">
            <h2>Admin Rija Cars</h2>
            <input type="email" id="admin-email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="password" id="admin-pass" placeholder="Password" style="width:100%; padding:10px; margin-bottom:10px;">
            <button onclick="loginAdmin()" style="width:100%; padding:10px; background:#3498db; color:white;">Connexion</button>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="admin-container">
            <h1>Administration Rija Cars</h1>
            <button onclick="logoutAdmin()" style="background:#c0392b; color:white; padding:10px;">Déconnexion</button>
            <br><br>

            <div style="margin-bottom:20px;">
                <button onclick="switchTab('dashboard')">Dashboard</button>
                <button onclick="switchTab('reservations')">Réservations</button>
                <button onclick="switchTab('maintenances')">Maintenances</button>
            </div>

            <div id="view-dashboard">
                <div id="grid-voitures" class="grid-dashboard"></div>
            </div>

            <div id="view-reservations" style="display:none;">
                
                <button onclick="document.getElementById('form-new-resa').style.display='block'" style="background:#2ecc71; color:white; padding:10px;">+ Nouvelle Réservation</button>
                
                <div id="form-new-resa" class="form-box" style="display:none; margin-top:10px;">
                    <h3>Nouvelle Réservation (Admin)</h3>
                    <div class="form-grid">
                        <div><label>Voiture</label><select id="new-resa-voiture"></select></div>
                        <div><label>Client Nom</label><input type="text" id="new-resa-nom"></div>
                        <div><label>Client Tél</label><input type="text" id="new-resa-tel"></div>
                        <div><label>Début</label><input type="date" id="new-resa-debut"></div>
                        <div><label>Fin</label><input type="date" id="new-resa-fin"></div>
                        
                        <div><label>Lieu Livraison</label><input type="text" id="new-resa-liv-lieu"></div>
                        <div><label>Heure Livraison</label><input type="time" id="new-resa-liv-heure"></div>
                        <div><label>Lieu Récup.</label><input type="text" id="new-resa-rec-lieu"></div>
                        <div><label>Heure Récup.</label><input type="time" id="new-resa-rec-heure"></div>
                        <div><label>Trajet</label><input type="text" id="new-resa-trajet"></div>

                        <div><label>Montant (Ar)</label><input type="number" id="new-resa-montant"></div>
                        <div><label>Déjà Payé</label><input type="number" id="new-resa-paye"></div>
                    </div>
                    <button onclick="creerReservationAdmin()" style="background:#2ecc71; color:white; padding:10px; width:100%; margin-top:10px;">Valider</button>
                </div>

                <div class="table-container" style="margin-top:20px;">
                    <table id="table-resa-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Client / Urgence</th>
                                <th>Voiture / Dates</th>
                                <th>Logistique & Trajet</th>
                                <th>Paiement (Payeur)</th>
                                <th>Finances</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-resa-full"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-maintenances" style="display:none;">...</div>
        </div>
    </div>

<script>
    // --- MEME CONFIG QUE SCRIPT.JS ---
    const SUPABASE_URL = 'https://ctijwjcjmbfmfhzwbguk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Login/Logout (Idem original)
    async function loginAdmin() {
        const email = document.getElementById('admin-email').value;
        const pass = document.getElementById('admin-pass').value;
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if(error) alert(error.message); else { document.getElementById('login-screen').style.display='none'; document.getElementById('admin-content').style.display='block'; chargerTableReservations(); chargerVoituresSelect(); }
    }
    async function logoutAdmin() { await sb.auth.signOut(); location.reload(); }

    function switchTab(t) {
        document.getElementById('view-dashboard').style.display='none';
        document.getElementById('view-reservations').style.display='none';
        document.getElementById('view-'+t).style.display='block';
    }

    async function chargerVoituresSelect() {
        const {data} = await sb.from('voitures').select('id, nom');
        const s = document.getElementById('new-resa-voiture');
        s.innerHTML = '';
        data.forEach(v => s.innerHTML += `<option value="${v.id}">${v.nom}</option>`);
    }

    // --- CREATION RESA ADMIN (Avec nouveaux champs) ---
    async function creerReservationAdmin() {
        const r = {
            id_voiture: document.getElementById('new-resa-voiture').value,
            nom: document.getElementById('new-resa-nom').value,
            tel: document.getElementById('new-resa-tel').value,
            date_debut: document.getElementById('new-resa-debut').value,
            date_fin: document.getElementById('new-resa-fin').value,
            montant_total: document.getElementById('new-resa-montant').value,
            paiement_montant_declare: document.getElementById('new-resa-paye').value,
            // Nouveaux champs
            lieu_livraison: document.getElementById('new-resa-liv-lieu').value,
            heure_livraison: document.getElementById('new-resa-liv-heure').value,
            lieu_recuperation: document.getElementById('new-resa-rec-lieu').value,
            heure_recuperation: document.getElementById('new-resa-rec-heure').value,
            trajet_details: document.getElementById('new-resa-trajet').value,
            statut: 'valide',
            code_otp: 'ADMIN'
        };
        await sb.from('reservations').insert([r]);
        alert("Réservation créée");
        chargerTableReservations();
    }

    // --- TABLEAU ET PDF ---
    async function chargerTableReservations() {
        const { data } = await sb.from('reservations').select('*, voitures(nom, ref_id)').order('id', {ascending:false});
        const tbody = document.getElementById('tbody-resa-full');
        tbody.innerHTML = '';

        data.forEach(r => {
            // Calculs
            const total = parseFloat(r.montant_total);
            const paye = parseFloat(r.paiement_montant_declare) || 0;
            const reste = total - paye;

            // Infos complètes "récupérées"
            const contactInfo = `<strong>${r.nom}</strong> ${r.prenom || ''}<br>${r.tel}<br>Urgence: ${r.urgence_nom || '-'} (${r.urgence_tel || '-'})`;
            const trajetInfo = `<strong>Départ:</strong> ${r.lieu_livraison || 'Agence'} (${r.heure_livraison || '-'})<br><strong>Retour:</strong> ${r.lieu_recuperation || 'Agence'} (${r.heure_recuperation || '-'})<br><strong>Trajet:</strong> ${r.trajet_details || '-'}`;
            const payeurInfo = `${r.paiement_methode || '-'}<br>Titulaire: <strong>${r.paiement_titulaire || '-'}</strong><br>Ref: ${r.paiement_ref || '-'}`;
            const financeInfo = `Total: ${total}<br>Payé: <span style="color:green">${paye}</span><br>Reste: <span style="color:red; font-weight:bold;">${reste}</span>`;

            tbody.innerHTML += `
            <tr>
                <td>#${r.id}</td>
                <td>${contactInfo}</td>
                <td>${r.voitures?.nom}<br>${r.date_debut} au ${r.date_fin}</td>
                <td style="font-size:0.85rem;">${trajetInfo}</td>
                <td>${payeurInfo}</td>
                <td>${financeInfo}</td>
                <td>
                    <button class="btn-action-small" style="background:#8e44ad" onclick="genererPDFAdmin(${r.id})"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn-action-small" style="background:#e74c3c" onclick="deleteResa(${r.id})">X</button>
                </td>
            </tr>`;
        });
    }

    // --- GENERATION PDF ADMIN (AVEC TOUTES LES NOUVELLES INFOS) ---
    async function genererPDFAdmin(id) {
        const { data: r } = await sb.from('reservations').select('*, voitures(nom)').eq('id', id).single();
        if(!r) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // En-tête
        doc.setFillColor(44, 62, 80); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(22);
        doc.text("RIJA NIAINA CAR SERVICES", 105, 15, {align:"center"});
        doc.setFontSize(10);
        doc.text("ADMINISTRATION - DUPLICATA", 105, 25, {align:"center"});

        doc.setTextColor(0,0,0);
        doc.text(`Facture N° ${r.id}`, 14, 50);

        // Contenu riche
        const client = `CLIENT\nNom: ${r.nom} ${r.prenom || ''}\nTél: ${r.tel}\nCIN: ${r.cin_passeport || '-'}\nAdresse: ${r.adresse || '-'}\n\nURGENCE\nNom: ${r.urgence_nom || '-'}\nTél: ${r.urgence_tel || '-'}`;
        
        const trajet = `VÉHICULE: ${r.voitures?.nom}\n\nDATES\nDu: ${r.date_debut}\nAu: ${r.date_fin}\n\nLOGISTIQUE\nLivraison: ${r.lieu_livraison || 'Agence'} (${r.heure_livraison || '-'})\nRécup: ${r.lieu_recuperation || 'Agence'} (${r.heure_recuperation || '-'})\n\nTRAJET PRÉVU\n${r.trajet_details || '-'}`;
        
        const paye = parseFloat(r.paiement_montant_declare) || 0;
        const reste = parseFloat(r.montant_total) - paye;
        
        const finance = `Total: ${r.montant_total} Ar\nPayé: ${paye} Ar\nReste: ${reste} Ar\n\nINFOS PAIEMENT\nMode: ${r.paiement_methode}\nPayeur: ${r.paiement_titulaire}\nRef: ${r.paiement_numero || r.paiement_ref}`;

        doc.autoTable({
            startY: 60,
            head: [['CLIENT', 'DÉTAILS & LOGISTIQUE', 'FINANCES']],
            body: [[client, trajet, finance]],
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            columnStyles: { 0: { cellWidth: 60 }, 1: { cellWidth: 80 }, 2: { cellWidth: 50 } }
        });

        doc.save(`Admin_Facture_${r.id}.pdf`);
    }

    async function deleteResa(id) { if(confirm("Supprimer ?")) await sb.from('reservations').delete().eq('id', id); chargerTableReservations(); }
</script>
</body>
</html>