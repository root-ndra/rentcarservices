<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rija Cars</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- STYLES SPÉCIFIQUES ADMIN --- */
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; }
        
        .admin-header { 
            background: white; padding: 15px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 100;
        }
        .user-profile-corner { display: flex; align-items: center; gap: 15px; }
        .user-name-display { font-weight: bold; color: #2c3e50; text-align: right; line-height: 1.2; }
        .user-role-badge { font-size: 0.75rem; color: #7f8c8d; font-weight: normal; }
        
        .admin-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* Onglets */
        .admin-tabs { 
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
            background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab-btn { 
            padding: 12px 20px; background: transparent; border: none; font-size: 0.95rem; 
            font-weight: 600; color: #555; cursor: pointer; border-radius: 6px; transition: 0.3s; 
            display: flex; align-items: center; gap: 8px; white-space: nowrap;
        }
        .tab-btn:hover { background: #f0f0f0; color: #2c3e50; }
        .tab-btn.active { background: #2c3e50; color: white; }

        /* Dashboard Grid */
        .grid-dashboard { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .car-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; position: relative; border-top: 5px solid transparent; }
        
        /* Status Colors */
        .status-dispo { border-top-color: #2ecc71; } .status-louee { border-top-color: #e74c3c; } .status-maintenance { border-top-color: #f39c12; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: white; text-transform: uppercase; }
        .bg-green { background: #2ecc71; } .bg-red { background: #e74c3c; } .bg-orange { background: #f39c12; } .bg-blue { background: #3498db; } .bg-gray { background: #95a5a6; } .bg-black { background: #333; }

        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .card-body { padding: 15px; }
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 10px; background: #f8f9fa; padding: 8px; border-radius: 8px; }
        .kpi-item { text-align: center; flex: 1; }
        .kpi-val { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .km-box { font-size: 0.85rem; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .mini-cal-container { margin-top: 10px; overflow-x: auto; overflow-y: hidden; }
        .fc { font-size: 0.65rem !important; min-width: 100%; }
        .fc table { width: 100% !important; font-size: 0.65rem !important; }
        .fc-toolbar-title { font-size: 0.8rem !important; }
        .fc-button { padding: 2px 4px !important; font-size: 0.65rem !important; }

        .vidange-container { margin-top: 10px; padding: 8px; background: #f0f3f4; border-radius: 8px; font-size: 0.8rem; }
        .vidange-bar-bg { height: 6px; background: #ddd; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .vidange-bar-fill { height: 100%; transition: width 0.5s; }
        .vidange-text { display: flex; justify-content: space-between; color: #555; font-size: 0.7rem; }

        .card-actions { padding: 10px; background: #f8f9fa; border-top: 1px solid #eee; display: flex; gap: 5px; }
        .btn-action { flex: 1; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-weight: 600; text-align:center; }
        .btn-maint { background: #f39c12; color: white; } .btn-km { background: #34495e; color: white; } .btn-hist { background: #95a5a6; color: white; }

        /* Tableaux */
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #2c3e50; color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; color: #333; font-size: 0.9rem; }
        tr:hover { background-color: #f9f9f9; }
        
        .btn-action-small { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.8rem; margin-right: 5px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-publish { background: #2ecc71; } .btn-hide { background: #f39c12; } .btn-delete { background: #e74c3c; } .btn-edit { background: #3498db; } .btn-freeze { background: #9b59b6; }
        .row-frozen { background-color: #f2f2f2; color: #999; }
        .row-frozen td { color: #999; }

        .form-box { background: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-box input, .form-box select, .form-box textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        .form-box label { font-weight: 600; font-size: 0.9rem; color: #555; display: block; margin-bottom: 5px; }
        .section-title-admin { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: #2c3e50; }

        .login-wrapper { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2c3e50; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 400px; text-align: center; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #777; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { border-bottom: 1px solid #eee; padding: 12px 5px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        
        @media (max-width: 768px) {
            .admin-header { flex-direction: column; gap: 15px; text-align: center; }
            .admin-tabs { flex-wrap: nowrap; overflow-x: auto; padding: 10px 0; gap: 5px; -webkit-overflow-scrolling: touch; }
            .tab-btn { flex: 0 0 auto; background: white; padding: 10px 15px; border: 1px solid #eee; }
            .grid-dashboard { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-wrapper">
        <div class="login-box">
            <h2>Admin Rija Cars</h2>
            <p style="color:#777; font-size:0.9rem; margin-bottom:20px;">Accès sécurisé</p>
            
            <input type="email" id="admin-email" placeholder="Email Administrateur" 
                   style="width:100%; padding:15px; margin-bottom:10px; font-size:1rem; border:1px solid #ccc; border-radius:5px;">
            
            <input type="password" id="admin-pass" placeholder="Mot de passe" 
                   style="width:100%; padding:15px; margin-bottom:20px; font-size:1rem; border:1px solid #ccc; border-radius:5px;">
            
            <button onclick="loginAdmin()" id="btn-login"
                    style="width:100%; padding:15px; background:#3498db; color:white; border:none; border-radius:5px; font-size:1.1rem; cursor:pointer;">
                Connexion
            </button>
            <p id="login-error" style="color:red; margin-top:15px; display:none; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="admin-content" style="display:none;">
        <div class="admin-header">
            <div>
                <h1 style="margin:0;">Administration</h1>
                <small>Gestion Rija Niaina Car Services</small>
            </div>
            
            <div class="user-profile-corner">
                <div class="user-name-display">
                    <span id="header-user-name">Chargement...</span><br>
                    <span id="header-user-role" class="user-role-badge">...</span>
                </div>
                <button onclick="ouvrirModalProfil()" title="Mon Profil" style="background:#ecf0f1; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; color:#2c3e50; font-size:1.1rem;">
                    <i class="fas fa-user-cog"></i>
                </button>
                <button onclick="logoutAdmin()" title="Déconnexion" style="background:#c0392b; color:white; border:none; border-radius:5px; padding:10px 15px; cursor:pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="admin-container">
            <div class="admin-tabs">
                <button id="btn-tab-dashboard" class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Tableau de Bord</button>
                <button id="btn-tab-reservations" class="tab-btn" onclick="switchTab('reservations')"><i class="fas fa-list-alt"></i> Réservations</button>
                <button id="btn-tab-partenaires" class="tab-btn" onclick="switchTab('partenaires')"><i class="fas fa-users-cog"></i> Partenaires</button>
                <button id="btn-tab-maintenances" class="tab-btn" onclick="switchTab('maintenances')"><i class="fas fa-tools"></i> Maintenances</button>
                <button id="btn-tab-promos" class="tab-btn" onclick="switchTab('promos')"><i class="fas fa-tags"></i> Codes Promo</button>
                <button id="btn-tab-avis" class="tab-btn" onclick="switchTab('avis')"><i class="fas fa-star"></i> Avis Clients</button>
                <button id="btn-tab-pubs" class="tab-btn" onclick="switchTab('pubs')"><i class="fas fa-ad"></i> Publicités</button>
                <button id="btn-tab-media" class="tab-btn" onclick="switchTab('media')"><i class="fas fa-music"></i> Divertissement</button>
                <button id="btn-tab-config" class="tab-btn" onclick="switchTab('config')"><i class="fas fa-cogs"></i> Configuration Site</button>
            </div>

            <div id="view-dashboard">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button onclick="ouvrirModalVoiture()" class="btn-publish" style="padding:10px 15px;">
                        <i class="fas fa-plus-car"></i> Ajouter une Voiture
                    </button>
                    <div>
                        <span style="margin-right:10px; font-weight:bold;">Période :</span>
                        <button class="btn-action-small active" style="background:#2c3e50;" onclick="setPeriode('mois')">Ce Mois</button>
                        <button class="btn-action-small" style="background:#95a5a6;" onclick="setPeriode('annee')">Cette Année</button>
                    </div>
                </div>
                <div id="grid-voitures" class="grid-dashboard"></div>
            </div>

            <div id="view-partenaires" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-user-plus"></i> Gestion / Création Partenaire</h3>
                    <div class="form-grid">
                        <div><label>Nom</label><input type="text" id="part-nom" placeholder="Nom de famille"></div>
                        <div><label>Prénom</label><input type="text" id="part-prenom" placeholder="Prénom"></div>
                        <div><label>Email (Connexion)</label><input type="email" id="part-email" placeholder="email@exemple.com"></div>
                        <div><label>Téléphone</label><input type="text" id="part-tel" placeholder="034..."></div>
                        <div><label>Durée Contrat</label>
                            <select id="part-duree" onchange="calculerFinContrat()">
                                <option value="7">7 jours</option>
                                <option value="30">1 mois</option>
                                <option value="90">3 mois</option>
                                <option value="180">6 mois</option>
                                <option value="365">1 an</option>
                            </select>
                        </div>
                        <div><label>Fin Contrat (Calcul auto)</label><input type="date" id="part-fin" readonly style="background:#eee;"></div>
                        <div><label>Royalties (%)</label>
                            <select id="part-royalties">
                                <option value="5">5%</option>
                                <option value="7">7%</option>
                                <option value="10">10%</option>
                                <option value="15" selected>15% (Standard)</option>
                                <option value="20">20%</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:10px; background:#e8f8f5; padding:10px; border-left:4px solid #2ecc71; font-size:0.9rem;">
                        <strong><i class="fas fa-info-circle"></i> Procédure :</strong> Remplissez ce formulaire pour définir les infos du contrat. Si l'utilisateur n'existe pas encore dans la base d'authentification, vous devrez l'inviter via l'interface Supabase > Authentication.
                    </div>
                    <button onclick="upsertPartenaire()" class="btn-publish" style="width:100%; margin-top:10px; padding:10px;">Enregistrer Fiche Partenaire</button>
                </div>
                
                <div class="table-container">
                    <table id="table-partenaires">
                        <thead><tr><th>Partenaire</th><th>Contact</th><th>Contrat / Fin</th><th>Royalties</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-partenaires"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reservations" style="display:none;">
                <button onclick="toggleNewResaForm()" style="margin-bottom:15px; background:#2ecc71; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;"><i class="fas fa-plus-circle"></i> Nouvelle Réservation (Comptoir)</button>
                <div id="form-new-resa" class="form-box" style="display:none; background:#e8f8f5;">
                    <h3 class="section-title-admin" style="margin-top:0;">Création Réservation Directe</h3>
                    <div class="form-grid">
                        <div><label>Voiture</label><select id="new-resa-voiture" onchange="calculerPrixAdmin()"></select></div>
                        <div><label>Client (Nom)</label><input type="text" id="new-resa-nom"></div>
                        <div><label>Client (Tel)</label><input type="text" id="new-resa-tel"></div>
                        <div><label>Début</label><input type="date" id="new-resa-debut" onchange="calculerPrixAdmin()"></div>
                        <div><label>Fin</label><input type="date" id="new-resa-fin" onchange="calculerPrixAdmin()"></div>
                        
                         <div><label>Lieu Livraison</label><input type="text" id="new-resa-liv-lieu"></div>
                        <div><label>Heure Livraison</label><input type="time" id="new-resa-liv-heure"></div>
                        <div><label>Lieu Récup.</label><input type="text" id="new-resa-rec-lieu"></div>
                        <div><label>Heure Récup.</label><input type="time" id="new-resa-rec-heure"></div>
                        <div><label>Trajet</label><input type="text" id="new-resa-trajet"></div>

                        <div><label>Montant (Ar)</label><input type="number" id="new-resa-montant" onchange="updateResteAdmin()"></div>
                        <div><label>Statut</label><select id="new-resa-statut"><option value="valide">Validé</option><option value="en_attente">En attente</option></select></div>
                        <div><label>Déjà Payé</label><input type="number" id="new-resa-paye" value="0" onchange="updateResteAdmin()"></div>
                        <div><label>Reste</label><input type="number" id="new-resa-reste" readonly style="background:#ddd;"></div>
                    </div>
                    <button id="btn-creer-resa" onclick="creerReservationAdmin()" class="btn-publish" style="width:100%; margin-top:15px; padding:10px;">Créer</button>
                </div>
                <div class="table-container">
                    <table id="table-resa-full">
                        <thead><tr><th>#ID</th><th>Client</th><th>Voiture</th><th>Paiement</th><th>Finances</th><th>OTP / Validation</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-resa-full"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-maintenances" style="display:none;">
                <div class="table-container">
                    <table id="table-maint-global">
                        <thead><tr><th>Date</th><th>Voiture</th><th>Type</th><th>Détails</th><th>Coût</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-maint-global"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-promos" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-tag"></i> Ajouter un Code Promo</h3>
                    <div class="form-grid">
                        <div><label>Code (ex: ETE2024)</label><input type="text" id="promo-code" placeholder="Code en majuscule"></div>
                        <div><label>Réduction (%)</label><input type="number" id="promo-pourcent" placeholder="Ex: 10"></div>
                        <div><label>Min. Jours</label><input type="number" id="promo-jours" placeholder="Ex: 3" value="1"></div>
                        <div><label>Date Début</label><input type="date" id="promo-debut"></div>
                        <div><label>Date Fin</label><input type="date" id="promo-fin"></div>
                    </div>
                    <button onclick="ajouterPromo()" class="btn-publish" style="width:100%; padding:12px; margin-top:10px;">Créer Code</button>
                </div>
                <div class="table-container">
                    <table id="table-promos">
                        <thead><tr><th>Code</th><th>Réduction</th><th>Conditions</th><th>Validité</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-promos"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-avis" style="display:none;">
                <div class="table-container">
                    <table id="table-avis">
                        <thead><tr><th>Date</th><th>Client</th><th>Note</th><th>Commentaire</th><th>Statut</th><th>Action</th></tr></thead>
                        <tbody id="tbody-avis"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-pubs" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-plus-circle"></i> Ajouter une Publicité</h3>
                    <div class="form-grid">
                        <div><label>Société</label><input type="text" id="pub-societe" placeholder="Nom de la société"></div>
                        <div><label>Contact</label><input type="text" id="pub-contact" placeholder="Tél ou Email"></div>
                        <div><label>Emplacement</label><select id="pub-emplacement"><option value="home_top">Accueil Haut</option><option value="home_bot">Accueil Bas</option><option value="flotte_top">Liste Voitures Haut</option></select></div>
                        <div><label>Lien Image (URL)</label><input type="text" id="pub-image" placeholder="https://..."></div>
                        <div><label>Lien Redirection</label><input type="text" id="pub-lien" placeholder="Site web"></div>
                        <div><label>Date Début</label><input type="date" id="pub-debut" onchange="calculerFinPub()"></div>
                        <div><label>Durée</label><select id="pub-duree" onchange="calculerFinPub()"><option value="7">7 jours</option><option value="15">15 jours</option><option value="30">1 mois</option><option value="90">3 mois</option><option value="365">1 an</option></select></div>
                        <div><label>Fin (Calculée)</label><input type="date" id="pub-fin" readonly style="background:#eee;"></div>
                    </div>
                    <button onclick="ajouterPub()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Enregistrer Pub</button>
                </div>
                <div class="table-container">
                    <table id="table-pubs">
                        <thead><tr><th>Société</th><th>Emplacement</th><th>Période</th><th>Image</th><th>Statut</th><th>Actions</th></tr></thead>
                        <tbody id="tbody-pubs"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-media" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-broadcast-tower"></i> Ajouter une Radio</h3>
                    <div class="form-grid">
                        <div><label>Nom</label><input type="text" id="rad-nom" placeholder="Ex: RDJ"></div>
                        <div><label>Flux</label><input type="text" id="rad-url" placeholder="http://stream..."></div>
                        <div><label>Logo (URL)</label><input type="text" id="rad-logo" placeholder="https://image..."></div>
                    </div>
                    <button onclick="ajouterRadio()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Ajouter Radio</button>
                </div>
                <div class="table-container"><table id="table-radios"><thead><tr><th>Logo</th><th>Nom</th><th>Flux</th><th>Statut</th><th>Action</th></tr></thead><tbody id="tbody-radios"></tbody></table></div>
                
                <div class="form-box" style="margin-top:40px;">
                    <h3 class="section-title-admin"><i class="fas fa-music"></i> Gestion Playlist</h3>
                    <input type="hidden" id="play-id-edit">
                    <div class="form-grid">
                        <div><label>Titre</label><input type="text" id="play-titre" placeholder="Ex: Top Hits"></div>
                        <div><label>Plateforme</label><select id="play-plateforme"><option value="youtube">YouTube</option><option value="spotify">Spotify</option><option value="deezer">Deezer</option></select></div>
                        <div><label>Lien</label><input type="text" id="play-url" placeholder="URL (Playlist ou Vidéo)"></div>
                    </div>
                    <button id="btn-save-playlist" onclick="ajouterPlaylist()" class="btn-publish" style="margin-top:15px; padding:10px 20px; width:100%;">Ajouter Playlist</button>
                </div>
                <div class="table-container"><table id="table-playlists"><thead><tr><th>Plateforme</th><th>Titre</th><th>Lien</th><th>Statut</th><th>Action</th></tr></thead><tbody id="tbody-playlists"></tbody></table></div>
            </div>

            <div id="view-config" style="display:none;">
                <div class="form-box">
                    <h3 class="section-title-admin"><i class="fas fa-cogs"></i> Paramètres Généraux</h3>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <div>
                            <h4 style="margin: 0 0 5px 0;">Affichage du Calendrier (Client)</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">Masquer ou afficher le calendrier de disponibilité sur la page d'accueil (index.html).</p>
                        </div>
                        <div>
                            <label class="switch" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <span id="status-calendar-text" style="font-weight: bold;">VISIBLE</span>
                                <input type="checkbox" id="toggle-calendar-global" checked onchange="toggleGlobalCalendar()">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-profil" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width:400px;">
            <span class="close-modal" onclick="fermerModal('modal-profil')">×</span>
            <h3><i class="fas fa-key"></i> Modifier mot de passe</h3>
            <div style="margin-top:20px;">
                <label>Nouveau mot de passe</label>
                <input type="password" id="new-pass-1" placeholder="Nouveau..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
                <label>Confirmer nouveau</label>
                <input type="password" id="new-pass-2" placeholder="Confirmer..." style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:5px;">
                <button onclick="changerMotDePasse()" class="btn-publish" style="width:100%;">Valider changement</button>
            </div>
        </div>
    </div>

    <div id="modal-maint" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" onclick="fermerModal('modal-maint')">×</span>
            <h3>Maintenance</h3>
            <input type="hidden" id="maint-id-voiture">
            <label>Type principal</label>
            <select id="maint-type" onchange="updateSousCategories()" style="width:100%; margin-bottom:10px; padding:10px;">
                <option value="">-- Sélectionner --</option>
                <option value="Vidange">Vidange</option>
                <option value="Pneus">Pneus</option>
                <option value="Freins">Freins</option>
                <option value="Mécanique">Mécanique</option>
                <option value="Carrosserie">Carrosserie</option>
                <option value="Autre">Autre</option>
            </select>
            <label id="lbl-sous-type" style="display:none;">Précisions (Sous-catégorie)</label>
            <select id="maint-sous-type" style="display:none; width:100%; margin-bottom:10px; padding:10px; background:#f9f9f9;">
            </select>
            <label>Compteur (Km)</label>
            <input id="maint-km" type="number" placeholder="KM Compteur" style="width:100%; margin-bottom:10px; padding:10px;">
            <label>Notes / Détails</label>
            <textarea id="maint-details" placeholder="Détails supplémentaires..." style="width:100%; margin-bottom:10px; padding:10px;"></textarea>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Début</label><input type="date" id="maint-debut" style="width:100%; margin-bottom:10px;"></div>
                <div style="flex:1"><label>Fin (Estimée)</label><input type="date" id="maint-fin" style="width:100%; margin-bottom:10px;"></div>
            </div>
            <label>Coût Total (Ar)</label>
            <input id="maint-cout" type="number" placeholder="Coût" style="width:100%; padding:10px;">
            <button onclick="sauvegarderMaintenance()" class="btn-publish" style="width:100%; margin-top:10px;">Enregistrer Maintenance</button>
        </div>
    </div>

    <div id="modal-km" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-km')">×</span><h3>Kilométrage</h3><input type="hidden" id="km-id-voiture"><input type="number" id="km-valeur" style="width:100%; padding:10px;"><button onclick="sauvegarderKm()" class="btn-dark" style="width:100%; margin-top:10px;">OK</button></div></div>
    <div id="modal-historique" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-historique')">×</span><h3>Historique</h3><h4 id="hist-titre-voiture"></h4><ul id="historique-list" class="history-list"></ul><div style="text-align:right; font-weight:bold; margin-top:10px;">Total: <span id="hist-total"></span></div></div></div>
    
    <div id="modal-voiture" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="fermerModal('modal-voiture')">×</span>
            <h3>Ajout Voiture</h3>
            <div class="form-grid">
                <div><label>Nom Modèle</label><input id="new-car-nom" placeholder="Ex: Chevrolet Cruze"></div>
                <div><label>Prix (Ar/jour)</label><input id="new-car-prix" type="number" placeholder="Ex: 160000"></div>
                <div><label>Places</label><input id="new-car-places" type="number" placeholder="Ex: 5" value="5"></div>
                
                <div><label>Transmission</label>
                    <select id="new-car-trans">
                        <option value="Manuelle">Manuelle</option>
                        <option value="Automatique">Automatique</option>
                    </select>
                </div>
                
                <div><label>Carburant</label>
                    <select id="new-car-carburant">
                        <option value="Essence">Essence</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Hybride">Hybride</option>
                        <option value="Electrique">Electrique</option>
                    </select>
                </div>
                
                <div><label>Type</label>
                    <select id="new-car-type">
                        <option>Berline</option>
                        <option>SUV</option>
                        <option>4x4</option>
                        <option>Minibus</option>
                    </select>
                </div>
                
                <div style="grid-column: span 2;">
                    <label>Description</label>
                    <textarea id="new-car-desc" rows="2" placeholder="Berline de luxe, idéale pour..."></textarea>
                </div>

                <div style="grid-column: span 2;">
                    <label>Image Principale (URL)</label>
                    <input id="new-car-img" placeholder="https://.../cruze1.jpg">
                </div>

                <div style="grid-column: span 2;">
                    <label>Autres Photos (URLs séparées par des virgules)</label>
                    <textarea id="new-car-photos-array" rows="2" placeholder="images/cruze2.jpg, images/cruze3.jpg"></textarea>
                </div>
                
                <div><label>Ref ID</label><input id="new-car-ref" placeholder="Ref ID"></div>
            </div>
            <button onclick="ajouterVoiture()" class="btn-publish" style="width:100%; margin-top:10px;">Créer</button>
        </div>
    </div>
    
    <div id="modal-edit-resa" class="modal-overlay" style="display:none;"><div class="modal-content"><span class="close-modal" onclick="fermerModal('modal-edit-resa')">×</span><h3>Modifier Resa</h3><input type="hidden" id="edit-resa-id"><p id="edit-resa-client"></p><input type="date" id="edit-resa-debut"><input type="date" id="edit-resa-fin"><input type="number" id="edit-resa-montant"><select id="edit-resa-statut"><option value="valide">Validé</option><option value="en_attente">Attente</option><option value="annulee">Annulée</option></select><button onclick="sauvegarderModificationResa()" class="btn-publish" style="width:100%; margin-top:10px;">MAJ</button></div></div>

    <script src="script.js"></script> <script>
    // --- AUTH & INIT (Idem Script.js mais spécifique Admin) ---
    // Note: Pour garder la cohérence, je remets le bloc script complet ici avec les MAJ.
    // Dans la réalité, vous devriez avoir un fichier admin.js séparé, mais ici je l'intègre pour être complet.
    
    const SUPABASE_URL = 'https://ctijwjcjmbfmfhzwbguk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aWp3amNqbWJmbWZoendiZ3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzEyOTgsImV4cCI6MjA4MTQwNzI5OH0.gEPvDc0lgf1o1Ol5AJFDPFG8Oh5SIbsZvg-8KTB4utk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let periodeAnalyse = 'mois';
    let globalVoitures = [];
    let currentUserRole = 'partenaire';

    // ... (Code existant pour maintenanceTypes, genererCouleur, verifierSession, loginAdmin, logoutAdmin, afficherDashboard, switchTab, toutRecharger, setPeriode, gestion profil, partenaires, dashboard, calendrier timeline) ...
    // JE NE REPETE PAS TOUT LE CODE EXISTANT POUR NE PAS DEPASSER LA LIMITE, JE ME CONCENTRE SUR LES AJOUTS DEMANDÉS.
    // Vous devez garder tout le code JS précédent de admin.html et remplacer/ajouter les fonctions suivantes :

    // --- NAVIGATION MISE A JOUR ---
    function switchTab(tabName) {
        ['dashboard', 'reservations', 'maintenances', 'avis', 'pubs', 'media', 'promos', 'partenaires', 'config'].forEach(t => { 
            const el = document.getElementById('view-'+t); if(el) el.style.display = 'none'; 
        });
        document.getElementById('view-'+tabName).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active');
        
        if(tabName==='reservations') chargerVoituresPourSelect(); 
        if(tabName==='maintenances') chargerTableMaintenances(); 
        if(tabName==='promos') chargerTablePromos(); 
        if(tabName==='partenaires') chargerTablePartenaires();
        if(tabName==='config') chargerConfigAdmin(); // NOUVEAU
    }

    // --- GESTION CALENDRIER GLOBAL (ADMIN) ---
    async function chargerConfigAdmin() {
        const { data, error } = await sb.from('config_site').select('value').eq('key', 'calendar_visible').single();
        const toggle = document.getElementById('toggle-calendar-global');
        const txt = document.getElementById('status-calendar-text');
        
        if (data) {
            // value est stocké comme jsonb, ex: true ou "true"
            let isVisible = (data.value === true || data.value === "true");
            toggle.checked = isVisible;
            txt.innerText = isVisible ? "VISIBLE" : "MASQUÉ";
            txt.style.color = isVisible ? "#2ecc71" : "#e74c3c";
        }
    }

    async function toggleGlobalCalendar() {
        const toggle = document.getElementById('toggle-calendar-global');
        const isVisible = toggle.checked;
        const txt = document.getElementById('status-calendar-text');
        
        txt.innerText = isVisible ? "VISIBLE" : "MASQUÉ";
        txt.style.color = isVisible ? "#2ecc71" : "#e74c3c";

        const { error } = await sb.from('config_site').upsert({ key: 'calendar_visible', value: isVisible });
        if(error) alert("Erreur sauvegarde config : " + error.message);
    }

    // --- AJOUT VOITURE AVEC NOUVEAUX CHAMPS ---
    function ouvrirModalVoiture() { document.getElementById('modal-voiture').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display='none'; }
    
    async function ajouterVoiture() {
        const { data: { user } } = await sb.auth.getUser();
        
        // Récupération des champs
        const nom = document.getElementById('new-car-nom').value;
        const prix = document.getElementById('new-car-prix').value;
        const places = document.getElementById('new-car-places').value;
        const transmission = document.getElementById('new-car-trans').value;
        const carburant = document.getElementById('new-car-carburant').value;
        const type = document.getElementById('new-car-type').value;
        const description = document.getElementById('new-car-desc').value;
        const imageMain = document.getElementById('new-car-img').value;
        const photosRaw = document.getElementById('new-car-photos-array').value;
        const ref = document.getElementById('new-car-ref').value;

        // Validation basique
        if(!nom || !prix) return alert("Nom et Prix requis");

        // Traitement galerie photos
        let photosArray = [];
        if (photosRaw) {
            photosArray = photosRaw.split(',').map(url => url.trim()).filter(url => url.length > 0);
        }
        // Ajoute l'image principale au début si elle n'est pas dedans (optionnel)
        if(imageMain && !photosArray.includes(imageMain)) {
             photosArray.unshift(imageMain);
        }

        const voiture = { 
            nom: nom, 
            type: type, 
            transmission: transmission, 
            prix_base: parseInt(prix), 
            image_url: imageMain, 
            ref_id: ref, 
            kilometrage: 0, 
            proprietaire_id: user.id,
            // Nouveaux champs
            places: parseInt(places),
            carburant: carburant,
            description: description,
            images: photosArray // Stocké en JSONB
        };

        const { error } = await sb.from('voitures').insert([voiture]);
        
        if(error) {
            alert("Erreur lors de l'ajout: " + error.message);
        } else {
            alert("Voiture ajoutée avec succès !");
            fermerModal('modal-voiture'); 
            chargerDashboard(); // Fonction existante dans votre ancien script
        }
    }

    // ... (Reste des fonctions existantes: maintenance, resas, etc.) ...
    
    // Initialisation
    // verifierSession(); // Assurez-vous que cette fonction est présente ou importée
    
    // Pour que ça marche "out of the box" dans ce fichier HTML, je copie les fonctions minimales de connexion
    async function verifierSession() {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            document.getElementById('login-screen').style.display = 'none'; 
            document.getElementById('admin-content').style.display = 'block'; 
            chargerConfigAdmin();
            chargerDashboard(); // Appel de la fonction du dashboard
        } else { 
            document.getElementById('login-screen').style.display = 'flex'; 
            document.getElementById('admin-content').style.display = 'none'; 
        }
    }
    
    // Note: Pour chargerDashboard, chargerVoituresPourSelect etc, assurez-vous d'avoir copié le code JS précédent de admin.html 
    // ou d'avoir inclus script.js qui contient la logique commune, mais ici nous avons besoin de la logique spécifique ADMIN.
    // Je suppose que vous gardez la logique de dashboard existante du fichier précédent.

    verifierSession();
</script>
</body>
</html>